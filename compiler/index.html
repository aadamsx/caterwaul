<!doctype html>
<html>
  <head>
    <title>Caterwaul Offline Compiler</title>
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js'></script>
    <script src='../caterwaul.js'></script>
    <script src='../modules/caterwaul.opt.min.js'></script>
    <script src='../modules/caterwaul.iter.min.js'></script>
    <script src='../modules/caterwaul.error.min.js'></script>
    <script src='../modules/caterwaul.format.min.js'></script>

    <script>
      $(caterwaul.clone('std')(function () {
        var c = caterwaul.clone('std', 'opt', 'format');

        var recompile = let[parse_errors_for = function (code) {try {return ! new Function(code)} catch (e) {return e.toString()}},
                              try_to_compile = function (c, code) {try {return c.macroexpand(c.parse(code))} catch (e) {return e.toString()}},
                                   serialize = fn[tree][tree.constructor === String ? tree : $('#minify').is(':checked') ? tree.serialize() : c.format(tree)],
                            create_caterwaul = fn_[let*[c1 = $('#std').is(':checked') ? caterwaul.clone('std') : caterwaul.clone(), c2 = $('#opt').is(':checked') ? c1.configure('opt') : c1,
                                                        c3 = $('#error').is(':checked') ? c2.configure('error') : c2, c4 = $('#iter').is(':checked') ? c3.configure('iter') : c3] in c4]] in
        fn_[$('#output').val(let[code = $('#code').val(), c = create_caterwaul()] in (code && (parse_errors_for(code) || serialize(try_to_compile(c, code)))) || '')];

        $('#code').keyup(let[timeout = null] in fn_[timeout && clearTimeout(timeout), timeout = setTimeout(recompile, 200)]);
        $('input').change(recompile);

        $('code > a').click(fn_[$('#code').val('#{$("#code").val()}\n#{$(this).text()}'), recompile()]);
      }));
    </script>

    <style>
      body {width: 900px; margin-left: auto; margin-right: auto; font-family: sans-serif; font-size: 10pt}
      h1, h2, h3, h4, h5, h6 {font-weight: normal; color: #f70}
      h1 {font-size: 16pt}
      h2 {font-size: 14pt}
      h3 {font-size: 10pt; color: #444}
      textarea {border: none; background: #eee; width: 440px; height: 5000px}
      li {color: #888; margin-bottom: 5px}
      li > code > a {color: #35a; text-decoration: none}
    </style>
  </head>
  <body>
    <h1>Caterwaul Offline Compiler</h1>
    <p>This compiler lets you preview macroexpansion. Here are some examples to get started (see <a href='http://spencertipping.com/caterwaul/caterwaul.html' target='_blank'>the Caterwaul
       documentation</a> for more information):</p>

    <h3>Standard macro library</h3>
    <ul><li><code><a href='javascript:void(0)'>let[x = 5] in x + 2;</a></code></li>
        <li><code><a href='javascript:void(0)'>fn[x][x + 1];</a></code></li>
        <li><code><a href='javascript:void(0)'>fb[x][this(x)];</a></code></li>
        <li><code><a href='javascript:void(0)'>fb_[this.method()];</a></code></li>
        <li><code><a href='javascript:void(0)'>fn_[this];</a></code></li>
        <li><code><a href='javascript:void(0)'>x + y, where[x = 6, y = 10];</a></code></li>
        <li><code><a href='javascript:void(0)'>console.log(x), when[x &gt; 0];</a></code></li>
        <li><code><a href='javascript:void(0)'>var plus = $+$;</a></code></li>
        <li><code><a href='javascript:void(0)'>let[f = $+$] in f(3, 4);</a></code></li>
        <li><code><a href='javascript:void(0)'>let[f = $+$][f(3, 4)];</a></code></li>
        <li><code><a href='javascript:void(0)'>let*[x = 5, y = x] in x + y;</a></code></li>
        <li><code><a href='javascript:void(0)'>x + y, where[x = 4, y = 6];</a></code></li>
        <li><code><a href='javascript:void(0)'>let[f(x) = x + 1] in f(6);</a></code></li>
        <li><code><a href='javascript:void(0)'>f(10)(20), where[f(x)(y) = x + y];</a></code></li>
        <li><code><a href='javascript:void(0)'>console.log('The value is #{1 + 2 + 3}');</a></code></li>
    </ul>

    <h3>Iteration macro library</h3>
    <ul><li><code><a href='javascript:void(0)'>iter.n[i, 10][console.log(i)];</a></code></li>
        <li><code><a href='javascript:void(0)'>iter.keys[k, document][console.log(k)];</a></code></li>
        <li><code><a href='javascript:void(0)'>iter.until[total >= 50][++total];</a></code></li></ul>

    <h3>Optimization macro library</h3>
    <ul><li><code><a href='javascript:void(0)'>opt.unroll[x, 100][console.log(x)];</a></code></li>
    </ul>

    <h3>Error handling macro library</h3>
    <ul><li><code><a href='javascript:void(0)'>error.quietly[(null).foo];</a></code></li>
        <li><code><a href='javascript:void(0)'>error.safely[(null).foo][console.log(error)];</a></code></li>
        <li><code><a href='javascript:void(0)'>x || error.fail[new Error('#{x} is not truthy')];</a></code></li>
    </ul>

    <div>
      <h2>Compiler options</h2>
      <div><label for='minify'>Condensed output</label><input type='checkbox' id='minify'/></div>
      <div><label for='std'>Standard macros ('std' module)</label><input type='checkbox' checked='checked' id='std'/></div>
      <div><label for='iter'>Iteration macros ('iter' module)</label><input type='checkbox' checked='checked' id='iter'/></div>
      <div><label for='opt'>Optimization macros ('opt' module)</label><input type='checkbox' checked='checked' id='opt'/></div>
      <div><label for='error'>Error handling macros ('error' module)</label><input type='checkbox' checked='checked' id='error'/></div>
    </div>
    <table>
      <tr><td><h2>Source</h2><textarea id='code'></textarea></td>
          <td><h2>Compiled</h2><textarea id='output' readonly='yes'></textarea></td></tr>
    </table>
  </body>
</html>
