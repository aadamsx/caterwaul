(function (f){return f(f)})(function (self){var fn=function (x){return new Function('$0','$1','$2','$3','$4','return '+x.replace(/@/g,'this.'))},qw=fn('$0.split(/\\s+/)'),gensym=(function (n,m){return function (){return '_gensym_'+n.toString(36)+'_'+(++m).toString(36)+'_'}})(+new Date(),Math.random()*(1<<30)>>>0),id=fn('$0'),bind=function (f,t){return f.binding===t?f:f.original?bind(f.original,t):merge(function (){return f.apply(t,arguments)},{original:f,binding:t})},map=function (f,xs){for (var i=0,ys=[],l=xs.length;i<l;++i)ys.push(f(xs[i],i));return ys},hash=function (s){for (var i=0,xs=qw(s),o={},l=xs.length;i<l;++i)o[xs[i]]=true;return annotate_keys(o)},merge=function (o){for (var i=1,l=arguments.length,_=null;_=arguments[i],i<l;++i)if (_)for (var k in _)has(_,k)&&(o[k]=_[k]);return o},extend=function (f){merge.apply(null,[f.prototype].concat(Array.prototype.slice.call(arguments,1)));return f},se=function (x,f){return f&&f.call(x,x)||x},annotate_keys=function (o){var max=0;for (var k in o)own.call(o,k)&&(max=k.length>max?k.length:max);o._max_length=max;return o},has=function (o,p){return p&&!(p.length>o._max_length)&&own.call(o,p)},own=Object.prototype.hasOwnProperty,_caterwaul=this.caterwaul,_global=this,lex_op=hash('. new ++ -- u++ u-- u+ u- typeof u~ u! ! * / % + - << >> >>> < > <= >= instanceof in == != === !== & ^ | && || ? = += -= *= /= %= &= |= ^= <<= >>= >>>= : , '+'return throw case var const break continue void u; ;'),lex_table=function (s){for (var i=0,xs=[false];i<8;++i)xs=xs.concat(xs);for (var i=0,l=s.length;i<l;++i)xs[s.charCodeAt(i)]=true;return xs},lex_float=lex_table('.0123456789'),lex_decimal=lex_table('0123456789'),lex_integer=lex_table('0123456789abcdefABCDEFx'),lex_exp=lex_table('eE'),lex_space=lex_table(' \n\r\t'),lex_bracket=lex_table('()[]{}'),lex_opener=lex_table('([{'),lex_punct=lex_table('+-*/%&|^!~=<>?:;.,'),lex_eol=lex_table('\n\r'),lex_regexp_suffix=lex_table('gims'),lex_quote=lex_table('\'"/'),lex_slash='/'.charCodeAt(0),lex_star='*'.charCodeAt(0),lex_back='\\'.charCodeAt(0),lex_x='x'.charCodeAt(0),lex_dot='.'.charCodeAt(0),lex_zero='0'.charCodeAt(0),lex_postfix_unary=hash('++ --'),lex_ident=lex_table('$_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'),lex=function (s){var s=s.toString(),mark=0,cs=[],c=0,re=true,esc=false,dot=false,exp=false,close=0,t='',ts=[],i=0,l=s.length,cs=function (i){return s.charCodeAt(i)};while ((mark=i)<l){while (lex_space[c=cs(i)]&&i<l)mark=++i;esc=exp=dot=t=false;if (lex_bracket[c]){t=!!++i;re=lex_opener[c]}else if (c===lex_slash&&cs(i+1)===lex_star&&(i+=2)){while (++i<l&&cs(i)!==lex_slash||cs(i-1)!==lex_star);t=!++i}else if (c===lex_slash&&cs(i+1)===lex_slash){while (++i<l&&!lex_eol[cs(i)]);t=false}else if (lex_quote[c]&&(close=c)&&re&&!(re=!(t=s.charAt(i)))){while (++i<l&&(c=cs(i))!==close||esc)esc=!esc&&c===lex_back;while (++i<l&&lex_regexp_suffix[cs(i)]);t=true}else if (c===lex_zero&&lex_integer[cs(i+1)]){while (++i<l&&lex_integer[cs(i)]);re=!(t=true)}else if (lex_float[c]&&(c!==lex_dot||lex_decimal[cs(i+1)])){while (++i<l&&(lex_decimal[c=cs(i)]||(dot^(dot|=c===lex_dot))||(exp^(exp|=lex_exp[c]&&++i))));while (i<l&&lex_decimal[cs(i)])++i;re=!(t=true)}else if (lex_punct[c]&&(t=re?'u':'',re=true)){while (i<l&&lex_punct[cs(i)]&&has(lex_op,t+s.charAt(i)))t+=s.charAt(i++);re=!has(lex_postfix_unary,t)}else {while (++i<l&&lex_ident[cs(i)]);re=has(lex_op,t=s.substring(mark,i))}if (i===mark)throw new Error('Internal error: The lexer failed to consume input and is throwing this error instead of entering an infinite loop.');t==='u;'&&(t=';');t!==false&&ts.push(t===true?s.substring(mark,i):t);}return ts},parse_reduce_order=map(hash,['function','( [ . [] ()','new','u++ u-- ++ -- typeof u~ u! u+ u-','* / %','+ -','<< >> >>>','< > <= >= instanceof in','== != === !==','&','^','|','&&','||','case','?','= += -= *= /= %= &= |= ^= <<= >>= >>>=',':',',','return throw break continue delete void','var const','if else try catch finally for switch with while do',';']),parse_associates_right=hash('= += -= *= /= %= &= ^= |= <<= >>= >>>= ~ ! new typeof u+ u- -- ++ u-- u++ ? if else function try catch finally for switch case with while do'),parse_inverse_order=(function (xs){for (var o={},i=0,l=xs.length;i<l;++i)for (var k in xs[i])has(xs[i],k)&&(o[k]=i);return annotate_keys(o)})(parse_reduce_order),parse_index_forward=(function (rs){for (var xs=[],i=0,l=rs.length,_=null;_=rs[i],xs[i]=true,i<l;++i)for (var k in _)if (has(_,k)&&(xs[i]=xs[i]&&!has(parse_associates_right,k)))break ;return xs})(parse_reduce_order),parse_lr=hash('[] . () * / % + - << >> >>> < > <= >= instanceof in == != === !== & ^ | && || = += -= *= /= %= &= |= ^= <<= >>= >>>= , : ;'),parse_r_until_block=annotate_keys({'function':2,'if':1,'do':1,'catch':1,'try':1,'for':1,'while':1}),parse_accepts=annotate_keys({'if':'else','do':'while','catch':'finally','try':'catch'}),parse_invocation=hash('[] ()'),parse_r_optional=hash('return throw break continue else'),parse_l=hash('++ --'),parse_r=hash('u+ u- u! u~ u++ u-- new typeof finally var const void delete'),parse_block=hash('; {'),parse_k_empty=fn('[]'),parse_group=annotate_keys({'(':')','[':']','{':'}','?':':'}),parse_invisible=hash('i;'),parse_ambiguous_group=hash('[ ('),parse_ternary=hash('?'),parse_not_a_value=hash('function if for while catch'),parse_also_expression=hash('function'),syntax_node_inspect=fn('$0 ? $0.inspect() : "(<>)"'),syntax_node_tostring=fn('$0 ? $0.serialize ? $0.serialize() : $0.toString() : ""'),syntax_node=extend(function (data){this.data=data;this.length=0;this.l=this.r=this.p=null;for (var i=1,l=arguments.length,_;_=arguments[i],i<l;++i)for (var j=0,lj=_.length,it;_.constructor===Array?(it=_[j],j<lj):(it=_,!j);++j)this.append(it.constructor===String?new this.constructor(it):it)},{replace:fn('($0.l = @l) && (@l.r = $0), ($0.r = @r) && (@r.l = $0), this'),append_to:fn('$0 && $0.append(this), this'),reparent:fn('@p && @p[0] === this && (@p[0] = $0), this'),fold_l:fn('@append(@l && @l.unlink(this))'),fold_lr:fn('@fold_l().fold_r()'),append:fn('(this[@length++] = $0) && ($0.p = this), this'),fold_r:fn('@append(@r && @r.unlink(this))'),fold_rr:fn('@fold_r().fold_r()'),sibling:fn('$0.p = @p, (@r = $0).l = this'),unlink:fn('@l && (@l.r = @r), @r && (@r.l = @l), @l = @r = null, @reparent($0)'),wrap:fn('$0.p = @replace($0).p, @reparent($0), @l = @r = null, @append_to($0)'),pop:fn('--@length, this'),push:fn('(this[@length++] = $0), this'),each:function (f){for (var i=0,l=this.length;i<l;++i)f(this[i],i);return this},map:function (f){for (var n=new syntax_node(this.data),i=0,l=this.length;i<l;++i)n.push(f(this[i],i)||this[i]);return n},reach:function (f){f(this);this.each(function (n){n.reach(f)});return this},rmap:function (f){var r=f(this);return !r||r===this?this.map(function (n){return n&&n.rmap(f)}):r},collect:function (p){var ns=[];this.reach(function (n){p(n)&&ns.push(n)});return ns},parents:function (){var ps=[],n=this.p;while (n)ps.push(n=n.p);return ps},s:function (data,xs){if (xs.constructor===Array){var i=0;return this.rmap(function (n){return n.data===data&&xs[i++]})}else return this.rmap(function (n){return n.data===data&&xs})},repopulated_with:function (xs){return new this.constructor(this.data,xs)},change:function (i,x){return se(new this.constructor(this.data,Array.prototype.slice.call(this)),function (n){n[i]=x})},compose_single:function (i,f){return this.change(i,f(this[i]))},flatten:function (){var d=this.data;return !(has(parse_lr,d)&&this.length)?this:has(parse_associates_right,d)?se(new this.constructor(d),bind(function (n){for (var i=this;i&&i.data===d;i=i[1])n.push(i[0]);n.push(i)},this)):se(new this.constructor(d),bind(function (n){for (var i=this,ns=[];i.data===d;i=i[0])i[1]&&ns.push(i[1]);ns.push(i);for (i=ns.length-1;i>=0;--i)n.push(ns[i])},this))},is_string:function (){return /['"]/.test(this.data.charAt(0))},as_escaped_string:function (){return this.data.substr(1,this.data.length-2)},is_number:function (){return /\d/.test(this.data)&&!/^[\/\w'"]/.test(this.data)},as_number:function (){return Number(this.data)},is_boolean:function (){return this.data==='true'||this.data==='false'},as_boolean:function (){return this.data==='true'},is_regexp:function (){return /^\/./.test(this.data)},as_escaped_regexp:function (){return this.data.substring(1,this.data.lastIndexOf('/'))},has_grouped_block:function (){return has(parse_r_until_block,this.data)},is_block:function (){return has(parse_block,this.data)},is_empty:fn('!@length'),is_constant:fn('@is_number() || @is_string() || @is_boolean() || @is_regexp() || @data === "null" || @data === "undefined"'),left_is_lvalue:fn('/=$/.test(@data) || /\\+\\+$/.test(@data) || /--$/.test(@data)'),has_parameter_list:fn('@data === "function" || @data === "catch"'),has_lvalue_list:fn('@data === "var" || @data === "const"'),is_dereference:fn('@data === "." || @data === "[]"'),is_invocation:fn('@data === "()"'),is_contextualized_invocation:fn('@is_invocation() && this[0] && this[0].is_dereference()'),toString:fn('@inspect()'),inspect:function (){return (this.l?'(left) <- ':'')+'('+this.data+(this.length?' '+map(syntax_node_inspect,this).join(' '):'')+')'+(this.r?' -> '+this.r.inspect():'')},serialize:function (){var op=this.data,right=this.r?'/* -> '+this.r.serialize()+' */':'',space=/\w/.test(op.charAt(op.length-1))?' ':'',s=has(parse_invisible,op)?map(syntax_node_tostring,this).join(space):has(parse_invocation,op)?map(syntax_node_tostring,[this[0],op.charAt(0),this[1],op.charAt(1)]).join(space):has(parse_ternary,op)?map(syntax_node_tostring,[this[0],op,this[1],parse_group[op],this[2]]).join(space):has(parse_group,op)?op+map(syntax_node_tostring,this).join(space)+parse_group[op]:has(parse_lr,op)?this.length?map(syntax_node_tostring,this).join(space+op+space):op:has(parse_r,op)||has(parse_r_optional,op)?op.replace(/^u/,'')+space+(this[0]?this[0].serialize():''):has(parse_r_until_block,op)?has(parse_accepts,op)&&this[1]&&this[1].data!=='{'&&this[2]&&parse_accepts[op]===this[2].data?op+space+map(syntax_node_tostring,[this[0],this[1],';',this[2]]).join(''):op+space+map(syntax_node_tostring,this).join(''):has(parse_l,op)?(this[0]?this[0].serialize():'')+space+op:op;return right?s+right:s}}),parse=function (ts){var grouping_stack=[],gs_top=null,head=null,parent=null,indexes=map(parse_k_empty,parse_reduce_order),all_nodes=[],invocation_nodes=[],new_node=function (n){return all_nodes.push(n),n},push=function (n){return head?head.sibling(head=n):(head=n.append_to(parent)),new_node(n)};for (var i=0,l=ts.length,_=null;_=ts[i],i<l;++i)_===gs_top?(grouping_stack.pop(),gs_top=grouping_stack[grouping_stack.length-1],head=head?head.p:parent,parent=null):(has(parse_group,_)?(grouping_stack.push(gs_top=parse_group[_]),parent=push(new syntax_node(_)),head=null):push(new syntax_node(_)),has(parse_inverse_order,_)&&indexes[parse_inverse_order[_]].push(head||parent));for (var i=0,l=indexes.length,forward=null,_=null;_=indexes[i],forward=parse_index_forward[i],i<l;++i)for (var j=forward?0:_.length-1,lj=_.length,inc=forward?1:-1,node=null,data=null;node=_[j],data=node&&node.data,forward?j<lj:j>=0;j+=inc)if (has(parse_lr,data))node.fold_lr();else if (has(parse_ambiguous_group,data)&&node.l&&(node.l.data==='.'||!(has(lex_op,node.l.data)||has(parse_not_a_value,node.l.data))))invocation_nodes.push(node.l.wrap(new_node(new syntax_node(data+parse_group[data]))).p.fold_r());else if (has(parse_l,data))node.fold_l();else if (has(parse_r,data))node.fold_r();else if (has(parse_ternary,data)){node.fold_lr();var temp=node[1];node[1]=node[0];node[0]=temp}else if (has(parse_r_until_block,data)&&node.r&&node.r.data!==':'){for (var count=0,limit=parse_r_until_block[data];count<limit&&node.r&&!has(parse_block,node.r.data);++count)node.fold_r();node.r&&node.r.data!==';'&&node.fold_r();if (has(parse_accepts,data)&&parse_accepts[data]===(node.r&&node.r.r&&node.r.r.data))node.fold_r().pop().fold_r();else if (has(parse_accepts,data)&&parse_accepts[data]===(node.r&&node.r.data))node.fold_r()}else if (has(parse_r_optional,data))node.r&&node.r.data!==';'&&node.fold_r();for (var i=all_nodes.length-1,_=null;_=all_nodes[i],i>=0;--i)_.r&&_.wrap(new syntax_node('i;')).p.fold_r();for (var i=0,l=invocation_nodes.length,_,child;_=invocation_nodes[i],i<l;++i)(child=_[1]=_[1][0])&&(child.p=_);while (head.p)head=head.p;return head;},macro_try_match=function (pattern,t){if (pattern.data==='_')return [t];if (pattern.data!==t.data||pattern.length!==t.length)return null;for (var i=0,l=pattern.length,wildcards=[],match=null;i<l;++i)if (match=macro_try_match(pattern[i],t[i]))wildcards=wildcards.concat(match);else return null;return wildcards},macro_expand=function (t,macros,expanders,context){return t.rmap(function (n){for (var i=0,l=macros.length,macro=null,match=null,replacement=null;i<l&&(macro=macros[i]);++i)if ((match=macro_try_match(macro,n))&&(replacement=expanders[i].apply(context,match)))return replacement})},compile=function (tree,environment){var s=gensym();return (new Function(s,'return ('+tree.rmap(function (n){return has(environment,n.data)&&new syntax_node('(',new syntax_node('.',new syntax_node(s),n))}).serialize()+')'))(environment)},associator_for=function (f){return function (name,behavior,value){return f[name]=(f.behaviors[f.attributes[name]=behavior]||id).call(f,value),f}},shallow_copy=function (x){return x&&(x.constructor===Array?Array.prototype.slice.call(x):merge({},x))},copy_of=function (f){var g=merge(function (){return g.init.apply(g,arguments)},{behaviors:shallow_copy(f.behaviors),attributes:{}});return se(g,function (g){(g.associate=associator_for(g))('behavior','method',function (name,definition){this.behaviors[name]=definition;return this.associate(name,'method',function (attribute,value){return this.associate(attribute,name,value)})}).behavior('method',g.behaviors.method);for (var k in f.attributes)has(f.attributes,k)&&g.associate(k,f.attributes[k],f[k])})};return this.caterwaul=merge(copy_of({behaviors:{method:function (v){return bind(v,this)}}}),{deglobalize:function (){_global.caterwaul=_caterwaul;return this}}).behavior('ref').behavior('shallow',shallow_copy).method('configuration',function (name,f){this.configurations[name]=f;return this}).method('tconfiguration',function (name,f){this.configurations[name]=this(f);return this}).shallow('compiler',{qs:parse(lex('qs[_]'))}).shallow('macro_patterns',[]).shallow('macro_expanders',[]).shallow('configurations',{}).shallow('has',{}).ref('syntax',syntax_node).ref('lex',lex).ref('parse_lexed',parse).ref('compile',compile).ref('gensym',gensym).ref('map',map).ref('self',self).method('reinitialize',fn('$1 = $0(@self), $1($1).deglobalize()')).method('parse',fn('@parse_lexed(@lex($0))')).method('decompile',fn('@parse($0.toString())')).method('expand',fn('@expand_qs(@macroexpand($0))')).method('macro',fn('@macro_patterns.push($0), @macro_expanders.push($1), this')).method('rmacro',function (pattern,expander){return this.macro(pattern,bind(function (){var t=expander.apply(this,arguments);return t&&this.macroexpand(t)},this))}).method('init',function (bindings,f){var expansion=this.expand(this.decompile(f||bindings));return compile(expansion.tree,merge(expansion.environment,f?bindings:{}))}).method('macroexpand',function (t){return macro_expand(t,this.macro_patterns,this.macro_expanders,this)}).method('expand_qs',function (t){var environment={},quote_function=function (tree){return se(gensym(),function (s){environment[s]=tree;return new syntax_node(s)})};return {environment:environment,tree:macro_expand(t,[this.compiler.qs],[quote_function],this)}}).shallow('util',{extend:extend,merge:merge,se:se,macro_try_match:macro_try_match,id:id,bind:bind,map:map,configurable:function (object){var function_for=function (name,change){return function (x){if (x===undefined)return this.options[name];else return this.options[name]=(change||id)(x),this}};object.options||(object.options={});for (var i=1,l=arguments.length,_;_=arguments[i],i<l;++i)if (_.constructor===String)object[_]=bind(function_for(_),object);else for (var k in _)if (_.hasOwnProperty(k))object[k]=bind(function_for(k,_[k]),object);return object}}).method('clone',function (){return arguments.length?this.clone().configure.apply(null,arguments):copy_of(this)}).method('configure',function (){for (var i=0,l=arguments.length,_;_=arguments[i],i<l;++i)if (_.constructor===String)this.configurations[_].call(this);else this(_).call(this);return this}).rmacro(parse(lex('qg[_]')),function (expression){return new this.syntax('(',expression)}).tconfiguration('fn',function (){this.rmacro(qs[fn[_][_]],function (vars,expression){return qs[qg[function (_){return _}]].s('_',[vars,expression])}).rmacro(qs[fn_[_]],function (expression){return qs[qg[function (){return _}]].s('_',[expression])}).rmacro(qs[let[_] in _],function (vars,expression){if (vars.data===',')vars=vars.flatten();return qs[fn[_][_].call(this,_)].s('_',[vars.data===','?vars.map(function (n){return n[0]}):vars[0],expression,vars.data===','?vars.map(function (n){return n[1]}):vars[1]])}).rmacro(qs[_,where[_]],function (expression,vars){return qs[(let[_] in qg[_])].s('_',[vars,expression])}).rmacro(qs[_,when[_]],function (expression,cond){return qs[qg[_]&&qg[_]].s('_',[cond,expression])}).rmacro(qs[_,unless[_]],function (expression,cond){return qs[qg[_]||qg[_]].s('_',[cond,expression])})}).tconfiguration('defmacro',function (){this.rmacro(qs[defmacro[_][_]],function (pattern,expansion){var expanded=this.expand(expansion);this.rmacro(pattern,this.compile(expanded.tree,expanded.environment));return qs[null]}).rmacro(qs[with_gensyms[_][_]],function (vars,expansion){if (vars.data!==',')return expansion.s(vars.data,new this.syntax(this.gensym()));for (var i=0,vars=vars.flatten(),l=vars.length;i<l;++i)expansion=expansion.s(vars[i].data,new this.syntax(this.gensym()));return qs[qs[_]].s('_',expansion)})}).tconfiguration('dfn',function (){this.rmacro(qs[_>$>_],function (vars,expansion){return qs[qg[function (_){return _}]].s('_',[vars.data==='('?vars[0]:vars,expansion])})}).tconfiguration('string',function (){this.rmacro(qs[_],function (s){if (!s.is_string()||!/#\{[^\}]+\}/.test(s.data))return false;var q=s.data.charAt(0),s=s.as_escaped_string(),eq=new RegExp('\\\\'+q,'g'),strings=s.split(/#\{[^\}]+\}/),xs=[],result=new this.syntax('+');s.replace(/#\{([^\}]+)\}/g,function (_,s){xs.push(s)});for (var i=0,l=xs.length;i<l;++i)result.push(new this.syntax(q+(i<strings.length?strings[i]:'')+q)).push(new this.syntax('(',this.parse(xs[i].replace(eq,q))));return new this.syntax('(',result.push(new this.syntax(q+(xs.length<strings.length?strings[strings.length-1]:'')+q)))})}).configuration('std',function (){this.configure('fn','dfn','defmacro','string')})});