#!/usr/bin/env node

// Waul: the offline precompiler for Caterwaul | Spencer Tipping
// Licensed under the terms of the MIT source code license

// Introduction.
// Caterwaul is useful as a library and an online compiler, but when performance is important you probably want to deliver precompiled code. Waul is a program that does exactly that. You write a
// regular file that invokes Caterwaul on a function, and Waul emits a Javascript file that contains the Caterwaul-compiled results. For example:

// | $ cat > test.waul <<EOF
//   caterwaul('js_all')(function ($) {
//     console.log('#{message} from caterwaul!')
//     -where [message = 'hello']})(caterwaul);
//   EOF
//   $ waul test.waul
//   $ node test.js
//   hello from caterwaul!
//   $

// Waul has some limitations:

// | 1. It cannot precompile any macros that generate refs (this includes the -eval- modifier, unfortunately, though as of 1.1.6 -using- works just fine).
//   2. You need to inform it about any Caterwaul extensions up-front (I'll explain how to do this).

// Extensions.
// Caterwaul can be extended with custom macros, and in order to precompile something that uses these extensions you'll have to inform Waul about them. You can do this with the --extension flag,
// like this:

// | $ waul --extension caterwaul.custom.js foo.waul

// This will result in Waul loading in the custom extensions before customizing the Caterwaul instance that is used inside foo.waul. Waul comes with the standard library built-in, but you can
// disable it:

// | $ waul --no-std foo.waul                              # just use Caterwaul core

// You can compile multiple files at once using multiple arguments. If you do this, each will be compiled to its own .js file.

// Running stuff.
// Waul can be used to execute things inside a node.js process as well as precompiling them. If you want to run something, use '--run' like this:

// | $ waul --run file.waul

// You can make this happen automatically by using a shebang line:

// | #!/path/to/waul --run
//   // Javascript code

// This will work because Caterwaul's parser recognizes # as a line comment marker. Note that if you use --run, only the file after --run will be executed. The others will be inactive arguments.
// Another way to do it is to symlink 'waul' as 'waulrun':

// | #!/usr/bin/env waulrun
//   // Javascript code

// Waul file format.
// A .waul file is a syntactic superset of a .js file. Any valid Javascript is valid Caterwaul, and because Caterwaul's parser is considerably more lenient than Javascript's, you can actually get
// away with quite a lot. In order to be compilable by Waul, your file must contain a toplevel function that looks like this:

// | caterwaul('configurations')(function ([parameters]) {
//     ...
//     })([arguments]);

// Waul will chuck a wobbly if your file doesn't have this form. Within the function, you can write things that are nonstandard Javascript. For example:

// | // NOTE: this example won't work until you write monad_syntax.
//   caterwaul('js_all monad_syntax')(function () {
//     console.log(x + 1 >>= x*x -given.x)})();

// Normally this would fail because you can't put arbitrary values on the left-hand side of an assignment, but because .waul files are never interpreted as Javascript it isn't a problem.

// Dependencies.
// This program depends on Caterwaul, which is baked in minified here. It includes the 'ui' library even though Waul itself doesn't use it. The reason is that Waul scripts are allowed to, so Waul
// needs to be prepared to precompile things that depend on it.

(function(a){return a(a)})(function(f,z,p){var ah=function(ap){return ap.split(/\s+/)},C=function(ap,aq){return aq&&aq.call(ap,ap)||ap},o=function(ap){throw new Error(ap)},c=z||(function(){for(var ap=[],ar="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789$_",aq=21,at;aq>=0;--aq){ap.push(ar.charAt(Math.random()*64>>>0))}return ap.join("")})(),Y=(function(ap){return function(aq){return[aq||"",(++ap).toString(36),c].join("_")}})(0),X=function(ap){return ap.substr(ap.length-22)===c},i=function(aq,ap){return function(){return aq.apply(ap,arguments)}},P=function(au,aq){for(var ar=0,at=[],ap=aq.length;ar<ap;++ar){at.push(au(aq[ar],ar))}return at},w=function(aq,ap){return P(function(ar){return ar instanceof Array?w(aq,ar):aq(ar)})},af=function(at){for(var ar=0,aq=ah(at),au={},ap=aq.length;ar<ap;++ar){au[aq[ar]]=true}return s(au)},ad=(function(aq){for(var ap in aq){if(aq.hasOwnProperty(ap)){return true}}})({toString:true})?function(au){for(var at=1,ap=arguments.length,ar;at<ap;++at){if(ar=arguments[at]){for(var aq in ar){if(g(ar,aq)){au[aq]=ar[aq]}}}}return au}:function(au){for(var at=1,ap=arguments.length,ar;at<ap;++at){if(ar=arguments[at]){for(var aq in ar){if(g(ar,aq)){au[aq]=ar[aq]}}if(ar.toString&&!/\[native code\]/.test(ar.toString.toString())){au.toString=ar.toString}}}return au},ac=Y("hash"),s=function(ar){var ap=0;for(var aq in ar){l.call(ar,aq)&&(ap=aq.length>ap?aq.length:ap)}ar[ac]=ap;return ar},g=function(aq,ap){return ap!=null&&!(ap.length>aq[ac])&&l.call(aq,ap)},l=Object.prototype.hasOwnProperty,ag=function(){var ap=function(){return ap.init.apply(ap,arguments)};return ap},ai=typeof caterwaul==="undefined"?p:caterwaul,ao=C(ag(),function(){this.deglobalize=function(){caterwaul=ai;return ao};ad(this,{merge:ad,map:P,rmap:w,gensym:Y,is_gensym:X})}),an=af(". new ++ -- u++ u-- u+ u- typeof u~ u! ! * / % + - << >> >>> < > <= >= instanceof in == != === !== & ^ | && || ? = += -= *= /= %= &= |= ^= <<= >>= >>>= : , return throw case var const break continue void else u; ;"),U=function(at){for(var ar=0,aq=[false];ar<8;++ar){aq.push.apply(aq,aq)}for(var ar=0,ap=at.length;ar<ap;++ar){aq[at.charCodeAt(ar)]=true}return aq},al=U(".0123456789"),W=U("0123456789"),y=U("0123456789abcdefABCDEFx"),M=U("eE"),j=U(" \n\r\t"),t=U("()[]{}?:"),r=U("([{?:"),x=U("+-*/%&|^!~=<>?:;.,"),K=U("\n\r"),k=U("gims"),Q=U("'\"/"),n="/".charCodeAt(0),V="0".charCodeAt(0),ak=af("++ --"),Z=U("$_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),T="*".charCodeAt(0),m="\\".charCodeAt(0),ab="x".charCodeAt(0),O=".".charCodeAt(0),I="#".charCodeAt(0),L=P(af,["function","( [ . [] ()","new delete","u++ u-- ++ -- typeof u~ u! u+ u-","* / %","+ -","<< >> >>>","< > <= >= instanceof in","== != === !==","&","^","|","&&","||","case","? = += -= *= /= %= &= |= ^= <<= >>= >>>=",":",",","return throw break continue void","var const","if else try catch finally for switch with while do",";"]),H=af("= += -= *= /= %= &= ^= |= <<= >>= >>>= ~ ! new typeof u+ u- -- ++ u-- u++ ? if else function try catch finally for switch case with while do"),F=(function(ar){for(var au={},at=0,ap=ar.length;at<ap;++at){for(var aq in ar[at]){g(ar[at],aq)&&(au[aq]=at)}}return s(au)})(L),v=(function(ar){for(var au=[],av=0,ap=ar.length,at=null;at=ar[av],au[av]=true,av<ap;++av){for(var aq in at){if(g(at,aq)&&(au[av]=au[av]&&!g(H,aq))){break}}}return au})(L),B=af("[] . () * / % + - << >> >>> < > <= >= instanceof in == != === !== & ^ | && || = += -= *= /= %= &= |= ^= <<= >>= >>>= , : ;"),aa=s({"function":2,"if":1,"do":1,"catch":1,"try":1,"for":1,"while":1,"with":1,"switch":1}),S=s({"if":"else","do":"while","catch":"finally","try":"catch"}),D=af("[] ()"),aj=af("return throw break continue else"),E=af("u+ u- u! u~ u++ u-- new typeof finally case var const void delete"),h=af("; {"),ae=af("i;"),J=af("++ --"),q=s({"(":")","[":"]","{":"}","?":":"}),G=af("[ ("),R=af("?"),e=af("function if for while catch void delete new typeof in instanceof"),A=af("function"),u=ao.syntax_common={_replace:function(ap){return(ap.l=this.l)&&(this.l.r=ap),(ap.r=this.r)&&(this.r.l=ap),this},_append_to:function(ap){return ap&&ap._append(this),this},_reparent:function(ap){return this.p&&this.p[0]===this&&(this.p[0]=ap),this},_fold_l:function(ap){return this._append(this.l&&this.l._unlink(this)||a)},_append:function(ap){return(this[this.length++]=ap)&&(ap.p=this),this},_fold_r:function(ap){return this._append(this.r&&this.r._unlink(this)||a)},_sibling:function(ap){return ap.p=this.p,(this.r=ap).l=this},_fold_lr:function(){return this._fold_l()._fold_r()},_fold_rr:function(){return this._fold_r()._fold_r()},_wrap:function(ap){return ap.p=this._replace(ap).p,this._reparent(ap),delete this.l,delete this.r,this._append_to(ap)},_unlink:function(ap){return this.l&&(this.l.r=this.r),this.r&&(this.r.l=this.l),delete this.l,delete this.r,this._reparent(ap)},pop:function(){return --this.length,this},push:function(ap){return this[this.length++]=ap||a,this},id:function(){var ap=Y("id");return(this.id=function(){return ap})()},is_caterwaul_syntax:true,each:function(ar){for(var aq=0,ap=this.length;aq<ap;++aq){ar(this[aq],aq)}return this},map:function(ar){for(var at=new this.constructor(this),aq=0,ap=this.length;aq<ap;++aq){at.push(ar(this[aq],aq)||this[aq])}return at},reach:function(ap){ap(this);this.each(function(aq){aq.reach(ap)});return this},rmap:function(aq){var ap=aq(this);return !ap||ap===this?this.map(function(ar){return ar.rmap(aq)}):ap===true?this:ap.rmap===p?new this.constructor(ap):ap},peach:function(ap){this.each(function(aq){aq.peach(ap)});ap(this);return this},pmap:function(aq){var ap=this.map(function(ar){return ar.pmap(aq)});return aq(ap)},clone:function(){return this.rmap(function(){return false})},collect:function(aq){var ap=[];this.reach(function(ar){aq(ar)&&ap.push(ar)});return ap},replace:function(ap){var aq;return l.call(ap,this.data)&&(aq=ap[this.data])?aq.constructor===String?C(this.map(function(ar){return ar.replace(ap)}),function(){this.data=aq}):aq:this.map(function(ar){return ar.replace(ap)})},repopulated_with:function(ap){return new this.constructor(this.data,ap)},with_data:function(ap){return new this.constructor(ap,Array.prototype.slice.call(this))},change:function(aq,ap){return C(new this.constructor(this.data,Array.prototype.slice.call(this)),function(ar){ar[aq]=ap})},compose_single:function(ap,aq){return this.change(ap,aq(this[ap]))},slice:function(aq,ap){return new this.constructor(this.data,Array.prototype.slice.call(this,aq,ap))},traverse:function(ap){ap({entering:this});ap({exiting:this.each(function(aq){aq.traverse(ap)})});return this},flatten:function(ap){ap=ap||this.data;return ap!==this.data?this.as(ap):!(g(B,ap)&&this.length)?this:g(H,ap)?C(new this.constructor(ap),i(function(ar){for(var aq=this;aq&&aq.data===ap;aq=aq[1]){ar.push(aq[0])}ar.push(aq)},this)):C(new this.constructor(ap),i(function(at){for(var aq=this,ar=[];aq.data===ap;aq=aq[0]){aq[1]&&ar.push(aq[1])}ar.push(aq);for(aq=ar.length-1;aq>=0;--aq){at.push(ar[aq])}},this))},unflatten:function(){var aq=this,ap=g(H,this.data);return this.length<=2?this:C(new this.constructor(this.data),function(au){if(ap){for(var at=0,ar=aq.length-1;at<ar;++at){au=au.push(aq[at]).push(at<ar-2?new aq.constructor(aq.data):aq[at])[1]}}else{for(var at=aq.length-1;at>=1;--at){au=au.push(at>1?new aq.constructor(aq.data):aq[0]).push(aq[at])[0]}}})},as:function(ap){return this.data===ap?this:new this.constructor(ap).push(this)},bindings:function(aq){var ap=aq||{};this.reach(function(ar){if(ar.binds_a_value){ap[ar.data]=ar.value}});return ap},expressions:function(aq){var ap=aq||{};this.reach(function(ar){if(ar.binds_an_expression){ap[ar.data]=ar.e}});return ap},contains:function(at){var ap=at(this);if(ap){return ap}for(var ar=0,aq=this.length;ar<aq;++ar){if(ap=this[ar].contains(at)){return ap}}},match:function(ar,at){ar=ar.constructor===String?ao.parse(ar):ar;at||(at={_:ar});if(this.is_wildcard()){return at[this.data]=ar,at}else{if(this.length===ar.length&&this.data===ar.data){for(var aq=0,ap=this.length;aq<ap;++aq){if(!this[aq].match(ar[aq],at)){return null}}return at}}},toString:function(){var ap=[""];this.serialize(ap);return ap.join("")},structure:function(){if(this.length){return"("+['"'+this.data+'"'].concat(P(function(ap){return ap.structure()},this)).join(" ")+")"}else{return this.data}}};ao.syntax_subclass=function(ar){var aq=Array.prototype.slice.call(arguments,1),ap=function(){return ar.apply(this,arguments)};ad.apply(this,[ap.prototype,u].concat(aq));ap.prototype.constructor=ap;return ap};var b=ao.parse_hex=function(at){for(var ap=0,ar=0,aq=at.length,au;ar<aq;++ar){ap*=16,ap+=(au=at.charCodeAt(ar))<=58?au-48:(au&95)-55}return ap},am=ao.parse_octal=function(at){for(var ap=0,ar=0,aq=at.length;ar<aq;++ar){ap*=8,ap+=at.charCodeAt(ar)-48}return ap},d=ao.unescape_string=function(au){for(var at=0,av,aq=au.length,ap=[],ar=false;at<aq;++at){if(ar){ar=false,ap.push((av=au.charAt(at))==="\\"?"\\":av==="n"?"\n":av==="r"?"\r":av==="b"?"\b":av==="f"?"\f":av==="0"?"\u0000":av==="t"?"\t":av==="v"?"\v":av==='"'||av==="'"?av:av==="x"?String.fromCharCode(b(au.substring(at,++at+1))):av==="u"?String.fromCharCode(b(au.substring(at,(at+=3)+1))):String.fromCharCode(am(au.substring(at,(at+=2)+1))))}else{if((av=au.charAt(at))==="\\"){ar=true}else{ap.push(av)}}}return ap.join("")};ao.javascript_tree_type_methods={is_string:function(){return/['"]/.test(this.data.charAt(0))},as_escaped_string:function(){return this.data.substr(1,this.data.length-2)},is_number:function(){return/^-?(0x|\d|\.\d+)/.test(this.data)},as_number:function(){return Number(this.data)},is_boolean:function(){return this.data==="true"||this.data==="false"},as_boolean:function(){return this.data==="true"},is_regexp:function(){return/^\/./.test(this.data)},as_escaped_regexp:function(){return this.data.substring(1,this.data.lastIndexOf("/"))},is_array:function(){return this.data==="["},as_unescaped_string:function(){return d(this.as_escaped_string())},is_wildcard:function(){return this.data.charCodeAt(0)===95},is_identifier:function(){return this.length===0&&/^[A-Za-z_$]\w*$/.test(this.data)&&!this.is_boolean()&&!this.is_null_or_undefined()&&!g(an,this.data)},has_grouped_block:function(){return g(aa,this.data)},is_block:function(){return g(h,this.data)},is_blockless_keyword:function(){return g(aj,this.data)},is_null_or_undefined:function(){return this.data==="null"||this.data==="undefined"},is_constant:function(){return this.is_number()||this.is_string()||this.is_boolean()||this.is_regexp()||this.is_null_or_undefined()},left_is_lvalue:function(){return/=$/.test(this.data)||/\+\+$/.test(this.data)||/--$/.test(this.data)},is_empty:function(){return !this.length},has_parameter_list:function(){return this.data==="function"||this.data==="catch"},has_lvalue_list:function(){return this.data==="var"||this.data==="const"},is_dereference:function(){return this.data==="."||this.data==="[]"},is_invocation:function(){return this.data==="()"},is_contextualized_invocation:function(){return this.is_invocation()&&this[0].is_dereference()},is_invisible:function(){return g(ae,this.data)},is_binary_operator:function(){return g(B,this.data)},is_prefix_unary_operator:function(){return g(E,this.data)},is_postfix_unary_operator:function(){return g(J,this.data)},is_unary_operator:function(){return this.is_prefix_unary_operator()||this.is_postfix_unary_operator()},accepts:function(ap){return g(S,this.data)&&S[this.data]===(ap.data||ap)}};ao.javascript_tree_serialization_methods={ends_with_block:function(){var ap=this[aa[this.data]];return this.data==="{"||g(aa,this.data)&&(this.data!=="function"||this.length===3)&&ap&&ap.ends_with_block()},serialize:function(at){var aq=this.length,au=this.data,ap=";\n",ar=function(av){if(Z[at[at.length-1].charCodeAt(0)]===Z[av.charCodeAt(0)]){at.push(" ",av)}else{at.push(av)}};switch(aq){case 0:if(g(aj,au)){return ar(au.replace(/^u/,""))}else{if(g(q,au)){return ar(au),ar(q[au])}else{return ar(au)}}case 1:if(g(E,au)||g(aj,au)){return ar(au.replace(/^u/,"")),this[0].serialize(at)}else{if(g(q,au)){return ar(au),this[0].serialize(at),ar(q[au])}else{if(g(B,au)){return ar("/* unary "+au+" node */"),this[0].serialize(at)}else{return this[0].serialize(at),ar(au)}}}case 2:if(g(D,au)){return this[0].serialize(at),ar(au.charAt(0)),this[1].serialize(at),ar(au.charAt(1))}else{if(g(aa,au)){return ar(au),this[0].serialize(at),this[1].serialize(at)}else{if(g(ae,au)){return this[0].serialize(at),this[1].serialize(at)}else{if(au===";"){return this[0].serialize(at),ar(ap),this[1].serialize(at)}else{return this[0].serialize(at),ar(au),this[1].serialize(at)}}}}default:if(g(R,au)){return this[0].serialize(at),ar(au),this[1].serialize(at),ar(":"),this[2].serialize(at)}else{if(g(aa,au)){return this.accepts(this[2])&&!this[1].ends_with_block()?(ar(au),this[0].serialize(at),this[1].serialize(at),ar(ap),this[2].serialize(at)):(ar(au),this[0].serialize(at),this[1].serialize(at),this[2].serialize(at))}else{return this.unflatten().serialize(at)}}}}};ao.ref_common=ad({},ao.javascript_tree_type_methods,ao.javascript_tree_serialization_methods,{replace:function(ap){var aq;return l.call(ap,this.data)&&(aq=ap[this.data])?aq.constructor===String?C(new this.constructor(this.value),function(){this.data=aq}):aq:this},length:0});ao.ref=ao.syntax_subclass(function(aq,ap){if(aq instanceof this.constructor){this.value=aq.value,this.data=aq.data}else{this.value=aq,this.data=Y(ap&&ap.constructor===String?ap:"ref")}},ao.ref_common,{binds_a_value:true});ao.expression_ref=ao.syntax_subclass(function(aq,ap){if(aq instanceof this.constructor){this.e=aq.e,this.data=aq.data}else{this.e=aq,this.data=Y(ap&&ap.constructor===String?ap:"e")}},ao.ref_common,{binds_an_expression:true});ao.syntax=ao.syntax_subclass(function(av){if(av instanceof this.constructor){this.data=av.data,this.length=0}else{this.data=av&&av.toString();this.length=0;for(var at=1,ap=arguments.length,ar;ar=arguments[at],at<ap;++at){for(var aq=0,ax=ar.length,au,aw;ar instanceof Array?(au=ar[aq],aq<ax):(au=ar,!aq);++aq){this._append((aw=au.constructor)===String||aw===Number||aw===Boolean?new this.constructor(au):au)}}}},ao.javascript_tree_type_methods,ao.javascript_tree_serialization_methods);var a=ao.empty=new ao.syntax("");ao.parse=function(ap){if(ap.constructor===ao.syntax){return ap}var aL=ap.toString(),av=0,aX=0,aI=true,aH=false,aZ=false,aY=false,aM=0,aJ="",aU=0,aR=aL.length,aC=function(a1){return aL.charCodeAt(a1)},aA=[],aQ=null,ay=null,aw=null,aq=P(function(){return[]},L),ax=[],aK=[a],aS=function(a1){return aK.push(a1),a1},aN=function(a1){return ay?ay._sibling(ay=a1):(ay=a1._append_to(aw)),aS(a1)},ar=this.syntax,az=[];if(aR===0){return a}while((av=aU)<aR){while(j[aX=aC(aU)]&&aU<aR){av=++aU}aH=aY=aZ=aJ=false;if(t[aX]){aJ=!!++aU;aI=r[aX]}else{if(aX===n&&aC(aU+1)===T&&(aU+=2)){while(++aU<aR&&aC(aU)!==n||aC(aU-1)!==T){}aJ=!++aU}else{if(aX===n&&aC(aU+1)===n){while(++aU<aR&&!K[aC(aU)]){}aJ=false}else{if(aX===I){while(++aU<aR&&!K[aC(aU)]){}aJ=false}else{if(Q[aX]&&(aM=aX)&&aI&&!(aI=!(aJ=aL.charAt(aU)))){while(++aU<aR&&(aX=aC(aU))!==aM||aH){aH=!aH&&aX===m}while(++aU<aR&&k[aC(aU)]){}aJ=true}else{if(aX===V&&y[aC(aU+1)]){while(++aU<aR&&y[aC(aU)]){}aI=!(aJ=true)}else{if(al[aX]&&(aX!==O||W[aC(aU+1)])){while(++aU<aR&&(W[aX=aC(aU)]||(aZ^(aZ|=aX===O))||(aY^(aY|=M[aX]&&++aU)))){}while(aU<aR&&W[aC(aU)]){++aU}aI=!(aJ=true)}else{if(x[aX]&&(aJ=aI?"u":"",aI=true)){while(aU<aR&&x[aC(aU)]&&g(an,aJ+aL.charAt(aU))){aJ+=aL.charAt(aU++)}aI=!g(ak,aJ)}else{while(++aU<aR&&(Z[aX=aC(aU)]||aX>127)){}aI=g(an,aJ=aL.substring(av,aU))}}}}}}}}if(aU===av){throw new Error('Caterwaul lex error at "'+aL.substr(av,40)+'" with leading context "'+aL.substr(av-40,40)+'" (probably a Caterwaul bug)')}if(aJ===false){continue}aJ=aJ===true?aL.substring(av,aU):aJ==="u;"?";":aJ;aJ===aQ?(aA.pop(),aQ=aA[aA.length-1],ay=ay?ay.p:aw,aw=null):(g(q,aJ)?(aA.push(aQ=q[aJ]),aw=aN(aS(new ar(aJ))),ay=null):aN(aS(new ar(aJ))),g(F,aJ)&&aq[F[aJ]].push(ay||aw));aI|=aJ===")"&&ay.l&&g(aa,ay.l.data)}for(var aU=0,aR=aq.length,aG,a0;a0=aq[aU],aG=v[aU],aU<aR;++aU){for(var aT=aG?0:a0.length-1,aF=a0.length,aV=aG?1:-1,aD,aW,aE;aG?aT<aF:aT>=0;aT+=aV){if(g(B,aW=(aD=a0[aT]).data)){aD._fold_lr()}else{if(g(G,aW)&&aD.l&&!((aE=aD.l.l)&&g(aa,aE.data))&&(aD.l.data==="."||(aD.l.data==="function"&&aD.l.length===2)||!(g(an,aD.l.data)||g(e,aD.l.data)))){ax.push(aD.l._wrap(aS(new ar(aW+q[aW]))).p._fold_r())}else{if(g(J,aW)){aD._fold_l()}else{if(g(E,aW)){aD._fold_r()}else{if(g(R,aW)){aD._fold_lr(),az.push(aD)}else{if(g(aa,aW)&&aD.r&&aD.r.data!==":"){for(var aO=0,aB=aa[aW];aO<aB&&aD.r&&!g(h,aD.r.data);++aO){aD._fold_r()}aD.r&&(aD.r.data===";"?aD.push(a):aD._fold_r());if(g(S,aW)&&S[aW]===(aD.r&&aD.r.r&&aD.r.r.data)){aD._fold_r().pop()._fold_r()}else{if(g(S,aW)&&S[aW]===(aD.r&&aD.r.data)){aD._fold_r()}}}else{if(g(aj,aW)){aD.r&&aD.r.data!==";"&&aD._fold_r()}}}}}}}}}for(var aU=aK.length-1,a0;aU>=0;--aU){(a0=aK[aU]).r&&a0._wrap(aS(new ar("i;"))).p._fold_r()}for(var aU=0,aR=ax.length,a0,at;aU<aR;++aU){(at=(a0=ax[aU])[1]=a0[1][0]||a)&&(at.p=a0)}for(var aU=0,aR=az.length,a0,aP,au;aU<aR;++aU){aP=(a0=az[aU]).length,au=a0[0],a0[0]=a0[aP-2],a0[1]=au,a0[2]=a0[aP-1],a0.length=3}while(ay.p){ay=ay.p}for(var aU=aK.length-1,a0;aU>=0;--aU){delete (a0=aK[aU]).p,delete a0.l,delete a0.r}return ay};(function(){var ap=ao.parse("var _bindings; return(_expression)"),at=ao.parse("_variable = _base._variable"),ar=ao.parse("undefined = void(0)"),aq=ao.parse("(function (_bindings) {return(_body)}).call(this, _expressions)");ao.compile=function(aF,az,aE){aE=ad({gensym_renaming:true},aE);aF=ao.late_bound_tree(aF);var aw=ad({},this._environment||{},az||{},aF.bindings()),aB=[ar],aD=Y("base");for(var ay in aw){if(l.call(aw,ay)&&ay!=="this"){aB.push(at.replace({_variable:ay,_base:aD}))}}var aC=new this.syntax(",",aB).unflatten(),au=ap.replace({_bindings:aC,_expression:aF});if(aE.gensym_renaming){var ax=this.gensym_rename_table(au);for(var ay in aw){l.call(aw,ay)&&(aw[ax[ay]||ay]=aw[ay])}au=au.replace(ax);aD=ax[aD]}var av=au.toString();try{return(new Function(aD,av)).call(aw["this"],aw)}catch(aA){throw new Error((aA.message||aA)+" while compiling "+av)}};ao.late_bound_tree=function(av,au){var az=ad({},au||{},av.expressions()),ay=new ao.syntax(","),ax=new ao.syntax(",");for(var aw in az){if(l.call(az,aw)){ay.push(new ao.syntax(aw)),ax.push(az[aw])}}return ay.length?aq.replace({_bindings:ay.unflatten(),_expressions:ax.unflatten(),_body:av}):av};ao.gensym_rename_table=function(aC){var aB={},az=[];aC.reach(function(aD){var aE=aD.data;if(X(aE)){aB[aE]||az.push(aE)}aB[aE]=aE.replace(/^(.*)_[a-z0-9]+_.{22}$/,"$1")||"anon"});var au={},aA=function(aD){if(!(aD in aB)){return aD}var aE=au[aD]||0;while(aB[aD+(++aE).toString(36)]){}return aD+(au[aD]=aE).toString(36)};for(var av={},ax=0,aw=az.length,ay;ax<aw;++ax){av[ay=az[ax]]||(aB[av[ay]=aA(aB[ay])]=true)}return av}})();var N=function(aq){for(var ar=aq.split(/\s+/),at=1,ap=ar.length,au=ao[ar[0]]();at<ap;++at){au=ao[ar[at]](au)}return au};ao.init=function(aq){aq||(aq=function(ar){return true});aq.constructor===Function||(aq=N(aq));var ap=function(au,ar,at){return au.constructor===Function||au.constructor===String?ao.compile(ap.call(ap,ao.parse(au)),ar,at):au.rmap(function(av){return aq.call(ap,av,ar,at)})};ap.global=ao;ap.macroexpander=aq;return ap};ao.initializer=f;ao.clone=function(){return C(f(f,c).deglobalize(),function(){for(var ap in ao){this[ap]||(this[ap]=ao[ap])}})};return caterwaul=ao});
(caterwaul.std_initializer=function(){(function($){var syntax_manipulator=function(base_case){var result=function(x){if(x.constructor===Array){for(var i=0,l=x.length,ys=[];i<l;++i){ys.push(result(x[i]))}return function(tree){for(var i=ys.length-1,r;i>=0;--i){if(r=ys[i].call(this,tree)){return r}}}}else{return x.constructor===String?result($.parse(x)):x.constructor===$.syntax?base_case.call(this,x):x}};return result};$.pattern=syntax_manipulator(function(pattern){return function(tree){return pattern.match(tree)}});$.expander=syntax_manipulator(function(expander){return function(match){return expander.replace(match)}});$.alternatives=syntax_manipulator(function(alternative){throw new Error("must use replacer functions with caterwaul.alternatives()")});$.reexpander=function(expander){var e=$.expander(expander);return function(match){var r=e.call(this,match);return r&&this(r)}};var composer=function(expander_base_case){return function(pattern,expander){var new_pattern=$.pattern(pattern),new_expander=expander_base_case(expander);return function(tree){var match=new_pattern.call(this,tree);return match&&new_expander.call(this,match)}}};$.replacer=composer($.expander);$.rereplacer=composer($.reexpander);$.macroexpand=function(tree){return $($.alternatives(Array.prototype.slice.call(arguments,1)))(tree)}})(caterwaul);(function($){$.anonymizer=function(){for(var translation_table={},i=0,l=arguments.length;i<l;++i){translation_table[arguments[i]]=$.gensym(arguments[i])}return function(node){return $.parse(node).replace(translation_table)}}})(caterwaul);(function($){$.js=function(macroexpander){var string_interpolator=function(node){var s=node.data,q=s.charAt(0),syntax=$.syntax;if(q!=="'"&&q!=='"'||!/#\{[^\}]+\}/.test(s)){return false}for(var pieces=[],is_code=[],i=1,l=s.length-1,brace_depth=0,got_hash=false,start=1,c;i<l;++i){if(brace_depth){if((c=s.charAt(i))==="}"){--brace_depth||(pieces.push(s.substring(start,i)),is_code.push(true))&&(start=i+1),got_hash=false}else{brace_depth+=c==="{"}}else{if((c=s.charAt(i))==="#"){got_hash=true}else{if(c==="{"&&got_hash){pieces.push(s.substring(start,i-1)),is_code.push(false),start=i+1,++brace_depth}else{got_hash=false}}}}pieces.push(s.substring(start,l)),is_code.push(false);for(var quoted=new RegExp("\\\\"+q,"g"),i=0,l=pieces.length;i<l;++i){pieces[i]=is_code[i]?this($.parse(pieces[i].replace(quoted,q)).as("(")):new syntax(q+pieces[i]+q)}return new syntax("+",pieces).unflatten().as("(")};var function_local_template=$.parse("var _x = _y"),function_bind_pattern=$.parse("_x = _y"),function_result_pattern=$.parse("result"),function_with_afters=$.parse("function (_formals) {_befores; var result = _result; _afters; return result}"),function_without_afters=$.parse("function (_formals) {_befores; return _result}"),function_assignment_template=$.parse("_f = _x"),function_is_result=function(n){return n.is_empty()&&n.data==="result"},function_destructure=$.rereplacer("_f(_xs) = _y",function(match){for(var formals=[],befores=[],afters=[],ps=match._xs.flatten(","),i=0,l=ps.length;i<l;++i){(afters.length||ps[i].contains(function_is_result)?afters:befores.length||ps[i].length?befores:formals).push(ps[i])}for(var contains_locals=[befores,afters],i=0,l=contains_locals.length;i<l;++i){for(var xs=contains_locals[i],j=0,lj=xs.length,m;j<lj;++j){xs[j]=(m=function_bind_pattern.match(xs[j]))&&m._x.is_empty()?function_local_template.replace(m):xs[j].as("(")}}var new_formals=formals.length?new $.syntax(",",formals).unflatten():$.empty,new_befores=befores.length?new $.syntax(";",befores).unflatten():$.empty,new_afters=afters.length?new $.syntax(";",afters).unflatten():$.empty,template=function_assignment_template.replace({_f:match._f,_x:afters.length?function_with_afters:function_without_afters});return template.replace({_formals:new_formals,_befores:new_befores,_afters:new_afters,_result:match._y})});var infix_function=function(node){var d=node.data,left,fn;if((d==="/"||d==="|")&&(left=node[0]).data===d&&left[1]&&left[1].data==="u-"&&(fn=left[1][0])){return new $.syntax("()",fn,this(node[0][0]).flatten(d).push(this(node[1])).with_data(",").unflatten())}};var infix_method=function(node){var d=node.data,left,fn;if((d==="/"||d==="|")&&(left=node[0]).data===d&&left[1]&&left[1].data==="u~"&&(fn=left[1][0])){var xs=[].slice.call(this(node[0][0]).flatten(d)),object=xs.shift();return new $.syntax("()",new $.syntax(".",new $.syntax("(",object),fn),new $.syntax(",",xs,this(node[1])).unflatten())}};var postfix_function_template=$.parse("_f(_x)"),postfix_function=$.rereplacer("_x /!_f",function(match){return postfix_function_template.replace({_f:match._f,_x:this(match._x).flatten("/").with_data(",").unflatten()})});var modified_literal_form=$.pattern("_literal._modifier"),lookup_literal_modifier=function(caterwaul,type,modifier){var hash=caterwaul.literal_modifiers[type];return hash.hasOwnProperty(modifier)&&hash[modifier]},literal_modifier=function(node){var modified_literal=modified_literal_form.call(this,node),literal,expander;if(modified_literal&&(literal=modified_literal._literal)&&(expander=literal.is_identifier()?lookup_literal_modifier(this,"identifier",modified_literal._modifier.data):literal.is_array()?lookup_literal_modifier(this,"array",modified_literal._modifier.data):literal.is_regexp()?lookup_literal_modifier(this,"regexp",modified_literal._modifier.data):literal.is_number()?lookup_literal_modifier(this,"number",modified_literal._modifier.data):literal.is_string()?lookup_literal_modifier(this,"string",modified_literal._modifier.data):null)){return expander.call(this,literal)}};var bracket_modifier_form=$.pattern("_modifier[_expression]"),slash_modifier_form=$.pattern("_expression /_modifier"),minus_modifier_form=$.pattern("_expression -_modifier"),in_modifier_form=$.pattern("_modifier in _expression"),pipe_modifier_form=$.pattern("_expression |_modifier"),comma_modifier_form=$.pattern("_expression, _modifier"),dot_parameters=$.pattern("_modifier._parameters"),bracket_parameters=$.pattern("_modifier[_parameters]"),parameterized_wickets=$.pattern("_expression <_modifier> _parameters"),parameterized_minus=$.pattern("_expression -_modifier- _parameters"),modifier=function(node){var modifier,parameterized_match=parameterized_wickets.call(this,node)||parameterized_minus.call(this,node);if(parameterized_match&&this.parameterized_modifiers.hasOwnProperty(modifier=parameterized_match._modifier.data)){var r=this.parameterized_modifiers[modifier].call(this,parameterized_match);if(r){return r}}var regular_match=bracket_modifier_form.call(this,node)||slash_modifier_form.call(this,node)||minus_modifier_form.call(this,node)||in_modifier_form.call(this,node)||pipe_modifier_form.call(this,node)||comma_modifier_form.call(this,node);if(regular_match){var parameter_match=dot_parameters.call(this,regular_match._modifier)||bracket_parameters.call(this,regular_match._modifier);if(parameter_match){regular_match._modifier=parameter_match._modifier;regular_match._parameters=parameter_match._parameters;return this.parameterized_modifiers.hasOwnProperty(modifier=regular_match._modifier.data)&&this.parameterized_modifiers[modifier].call(this,regular_match)}else{return this.modifiers.hasOwnProperty(modifier=regular_match._modifier.data)&&this.modifiers[modifier].call(this,regular_match)}}};var each_node=function(node){return string_interpolator.call(this,node)||literal_modifier.call(this,node)||node.length&&(modifier.call(this,node)||function_destructure.call(this,node)||infix_function.call(this,node)||infix_method.call(this,node)||postfix_function.call(this,node))},result=macroexpander?$(function(node){return macroexpander.call(this,node)||each_node.call(this,node)}):$(each_node);result.modifiers={};result.parameterized_modifiers={};result.literal_modifiers={regexp:{},array:{},string:{},number:{},identifier:{}};return result}})(caterwaul);(function($){$.js_literals=function(caterwaul_function){var function_template=$.parse("function (_) {return _body}");(function(r){r.x=$.reexpander(function(node){return node.with_data(node.data.replace(/\s+/g,""))});var call_exec_template=$.parse("_regexp.exec(_)");r.qf=function(node){return function_template.replace({_body:call_exec_template.replace({_regexp:node})})}})(caterwaul_function.literal_modifiers.regexp);(function(s){s.qw=$.reexpander(function(node){for(var array_node=new $.syntax("["),comma=new $.syntax(","),delimiter=node.data.charAt(0),pieces=node.as_escaped_string().split(/\s+/),i=0,l=pieces.length;i<l;++i){comma.push(new $.syntax(delimiter+pieces[i]+delimiter))}return array_node.push(comma.unflatten())});s.qh=$.reexpander(function(node){for(var hash_node=new $.syntax("{"),comma=new $.syntax(","),delimiter=node.data.charAt(0),pieces=node.as_escaped_string().split(/\s+/),i=0,l=pieces.length;i<l;i+=2){comma.push(new $.syntax(":",new $.syntax(delimiter+pieces[i]+delimiter),new $.syntax(delimiter+pieces[i+1]+delimiter)))}return hash_node.push(comma.unflatten())});s.qr=$.reexpander(function(node){return node.with_data("/"+node.as_escaped_string().replace(/\//g,"\\/")+"/")});s.qs=function(node){return new $.ref($.parse(node.as_unescaped_string()))};s.qf=$.reexpander(function(node){return function_template.replace({_body:$.parse(node.as_unescaped_string())})})})(caterwaul_function.literal_modifiers.string);return caterwaul_function}})(caterwaul);(function($){var scope_template=$.parse("(function () {var _variables; return (_expression)}).call(this)"),trivial_node_template=$.parse("new caterwaul.syntax(_data)"),nontrivial_node_template=$.parse("new caterwaul.syntax(_data, _xs)");$.words=function(caterwaul_function){$.merge(caterwaul_function.modifiers,$.words.modifiers);$.merge(caterwaul_function.parameterized_modifiers,$.words.parameterized_modifiers);return caterwaul_function};$.syntax_to_expression=function(tree){if(tree.length){for(var comma=new $.syntax(","),i=0,l=tree.length;i<l;++i){comma.push($.syntax_to_expression(tree[i]))}return nontrivial_node_template.replace({_data:'"'+tree.data.replace(/"/g,'\\"').replace(/\n/g,"\\n")+'"',_xs:comma.unflatten()})}else{return trivial_node_template.replace({_data:'"'+tree.data.replace(/"/g,'\\"').replace(/\n/g,"\\n")+'"'})}};$.words.modifiers={qs:function(match){return new $.expression_ref($.syntax_to_expression(match._expression),"qs")},qse:function(match){return new $.expression_ref($.syntax_to_expression(this(match._expression)),"qse")},reexpand:function(match){return this(this(match._expression))},noexpand:function(match){return match._expression},raise:$.reexpander("(function () {throw _expression}).call(this)"),eval:function(match){return new $.ref($.compile(this(match._expression)),"eval")},delay:$.reexpander("(function (t, f) {return (function () {return f.call(t)})})(this, (function () {return _expression}))"),lazy:$.reexpander("(function (t, f, v, vc) {return (function () {return vc ? v : (vc = true, v = f.call(t))})})(this, (function () {return _expression}))"),capture:function(match){for(var comma=new $.syntax(","),bindings=match._expression.flatten(","),i=0,l=bindings.length;i<l;++i){comma.push(this(bindings[i]).with_data(":"))}return new $.syntax("{",comma.unflatten())},wcapture:function(match){for(var e=this(match._expression),comma=new $.syntax(","),bindings=e.flatten(","),node,i=0,l=bindings.length;i<l;++i){(node=this(bindings[i]))[1]=node[0],comma.push(node.with_data(":"))}return scope_template.replace({_variables:e,_expression:new $.syntax("{",comma.unflatten())})}};$.words.parameterized_modifiers={given:$.reexpander("(function (_parameters) {return _expression})"),bgiven:$.reexpander("(function (t, f) {return (function () {return f.apply(t, arguments)})})(this, (function (_parameters) {return _expression}))"),rescue:$.reexpander("(function () {try {return (_expression)} catch (e) {return (_parameters)}}).call(this)"),se:$.reexpander("(function (it) {return (_parameters), it}).call(this, (_expression))"),re:$.reexpander("(function (it) {return (_parameters)}).call(this, (_expression))"),where:$.reexpander("(function () {var _parameters; return (_expression)}).call(this)"),using:$.reexpander(function(match){var m=this(match._parameters),o=$.compile(m),comma=new $.syntax(","),expression_ref=new $.expression_ref(m);for(var k in o){if(Object.prototype.hasOwnProperty.call(o,k)){comma.push(new $.syntax("=",k,new $.syntax(".",expression_ref,k)))}}return scope_template.replace({_variables:comma.unflatten(),_expression:match._expression})}),when:$.reexpander("((_parameters) && (_expression))"),and:$.reexpander("((_expression) && (_parameters))"),unless:$.reexpander("(! (_parameters) && (_expression))"),or:$.reexpander("((_expression) || (_parameters))")}})(caterwaul);caterwaul.words(caterwaul.js())(function($){$.seq(caterwaul_function)=caterwaul_function-se[it.modifiers.seq(match)=seq_expand.call(seq_expand,anon_pattern.replace({_x:match._expression}))-re-this(it)/when.it]-where[anon_pattern=anon("S[_x]"),seq_expand=$($.alternatives(operator_macros.concat(word_macros)))],where[anon=$.anonymizer("S"),rule(p,e)=$.rereplacer(p.constructor===String?anon(p):p,e.constructor===String?anon(e):e),operator_macros=[rule("S[_x]","_x"),rule("S[_xs + _ys]",concat),rule("S[_xs ^ _ys]",zip),rule("S[_xs - _ys]",cross),rule("S[(_x)]","(S[_x])"),rule("S[_x[_y]]","S[_x][_y]"),rule("S[_xs(_ys)]","S[_xs](_ys)"),rule("S[[_x]]","[_x]"),rule("S[_x, _y]","S[_x], S[_y]"),rule("S[_xs._p]","S[_xs]._p"),rule("S[~[_x]]","[S[_x]]"),rule("S[~_xs(_ys)]","S[_xs](S[_ys])"),rule("S[_x ? _y : _z]","(S[_x]) ? (S[_y]) : (S[_z])"),rule("S[_x && _y]","(S[_x]) && (S[_y])"),rule("S[_x || _y]","(S[_x]) || (S[_y])"),rule("S[+_xs]","Array.prototype.slice.call((_xs))"),rule("S[_xs %_thing]",handle_filter_forms),rule("S[_xs *_thing]",handle_map_forms),rule("S[_xs /_thing]",handle_fold_forms),rule("S[_xs |_thing]",handle_exists_forms),rule("S[_xs %k*_thing]",handle_kmap_forms),rule("S[_xs %v*_thing]",handle_vmap_forms),rule("S[_xs %k%_thing]",handle_kfilter_forms),rule("S[_xs %v%_thing]",handle_vfilter_forms)]-where[unrecognized(reason)=raise[new Error(reason)],use_form(form,xs,body,init,vars)=form?form.replace({_f:body,_init:init}).replace($.merge({_s:xs},vars)):unrecognized("unsupported sequence operator or modifiers used on #{body}"),operator_case(forms)(match)=parse_modifiers(match._thing,use(forms.normal,forms.inormal),use(forms.bang,forms.ibang),use(forms.tbang,forms.itbang))-where[xs=match._xs,expander=this,form_function(form)(body,vars)=use_form(form,xs,body,null,vars),iform_function(form)(body,init,vars)=use_form(form,xs,body,init,vars),use(form,iform)(body)=parse_body(body,expander,form_function(form),iform_function(iform))],handle_map_forms=operator_case({normal:map,bang:each,tbang:flatmap,itbang:iterate}),handle_filter_forms=operator_case({normal:filter,bang:filter_not,tbang:map_filter,itbang:imap_filter}),handle_fold_forms=operator_case({normal:foldl,bang:foldr,tbang:unfold,inormal:ifoldl,ibang:ifoldr,itbang:iunfold}),handle_kmap_forms=operator_case({normal:kmap,bang:keach}),handle_kfilter_forms=operator_case({normal:kfilter,bang:kfilter_not,tbang:kmap_filter}),handle_vmap_forms=operator_case({normal:vmap,bang:veach}),handle_vfilter_forms=operator_case({normal:vfilter,bang:vfilter_not,tbang:vmap_filter}),handle_exists_forms=operator_case({normal:exists,bang:not_exists}),block=anon("[_x]"),block_with_variable=anon("_var[_x]"),block_with_init=anon("[_init][_x]"),block_with_variable_and_init=anon("_var[_init][_x]"),block_with_closure=anon("+_x"),block_with_seq=anon("~_x"),standard_names={_x:"x",_x0:"x0",_xi:"xi",_xl:"xl",_xs:"xs",_xr:"xr"},prefixed_names(p)={_x:p,_x0:"#{p}0",_xi:"#{p}i",_xl:"#{p}l",_xs:"#{p}s",_xr:"#{p}r"},function_promotion=anon("(_f).call({_x0: _x0, _xi: _xi, _xl: _xl, _xs: _xs, _xr: _xr}, _x)"),promote_function(f)=function_promotion.replace({_f:f}),closure_wrapper=anon("(function (_x, _x0, _xi, _xl, _xs, _xr) {return _f}).call(this, _x, _x0, _xi, _xl, _xs, _xr)"),close_body(vars,f)=closure_wrapper.replace(vars).replace({_f:f}),seq_pattern=anon("S[_x]"),promote_seq(f)=seq_pattern.replace({_x:f}),parse_body(tree,expand,normal,init)=((r=block_with_seq.match(tree))?parse_body(r._x,expand,sequence_context_normal,sequence_context_init):(r=block_with_closure.match(tree))?parse_body(r._x,expand,wrapping_normal,wrapping_init):(r=block_with_variable_and_init.match(tree))?init(r._x,r._init,prefixed_names(r._var)):(r=block_with_init.match(tree))?init(r._x,r._init,standard_names):(r=block_with_variable.match(tree))?normal(r._x,prefixed_names(r._var)):(r=block.match(tree))?normal(r._x,standard_names):normal(promote_function(tree),standard_names))-where[in_sequence_context(f)=expand.call(expand,promote_seq(f)),sequence_context_normal(f,names)=normal(in_sequence_context(f),names),sequence_context_init(f,init_expression,names)=init(in_sequence_context(f),init_expression,names),wrapping_normal(f,names)=normal(close_body(names,f),names),wrapping_init(f,init_expression,names)=init(close_body(names,f),init_expression,names),r=null],tbang_modifier=anon("~!_x"),bang_modifier=anon("!_x"),parse_modifiers(tree,normal,bang,tbang)=((result=tbang_modifier.match(tree))?tbang(result._x):(result=bang_modifier.match(tree))?bang(result._x):normal(tree))-where[result=null]]-where[loop_anon=$.anonymizer("x","y","i","j","l","lj","r","o","k"),scope=anon("(function (_xs) {var _x, _x0, _xi, _xl, _xr; _body}).call(this, S[_s])"),scoped(t)=scope.replace({_body:t}),expand(s)=s.replace(/@/g,"Array.prototype.slice.call").replace(/#/g,"Object.prototype.hasOwnProperty.call").replace(/%%/g,".constructor"),form(x)=x/!expand/!anon/!scoped/!loop_anon,map=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length; _xi < _xl; ++_xi) _x = _xs[_xi], _xr.push((_f));               return _xr"),each=form("for (var                    _xi = 0, _xl = _xs.length; _xi < _xl; ++_xi) _x = _xs[_xi], (_f);                         return _xs"),flatmap=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length; _xi < _xl; ++_xi) _x = _xs[_xi], _xr.push.apply(_xr, @((_f))); return _xr"),iterate=form("for (var _x = _xs, _xi = 0, _x0, _xl;              _x0 = (_init); ++_xi) _x = (_f);                                   return _x"),filter=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length, _x0;     _xi < _xl; ++_xi) _x = _xs[_xi], (_f) && _xr.push(_x);        return _xr"),filter_not=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length, _x0;     _xi < _xl; ++_xi) _x = _xs[_xi], (_f) || _xr.push(_x);        return _xr"),map_filter=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length, _x0, _y; _xi < _xl; ++_xi) _x = _xs[_xi], (_y = (_f)) && _xr.push(_y); return _xr"),imap_filter=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length, _x0; _xi < _xl; ++_xi) _x = _xs[_xi], (_x0 = (_init)) && _xr.push(_f); return _xr"),foldl=form("for (var _x0 = _xs[0], _xi = 1, _xl = _xs.length;            _xi < _xl; ++_xi) _x = _xs[_xi], _x0 = (_f); return _x0"),foldr=form("for (var _xl = _xs.length, _xi = _xl - 2, _x0 = _xs[_xl - 1]; _xi >= 0; --_xi) _x = _xs[_xi], _x0 = (_f); return _x0"),unfold=form("for (var _xr = [], _x = _xs, _xi = 0;                      _x !== null; ++_xi) _xr.push(_x), _x = (_f);   return _xr"),ifoldl=form("for (var _x0 = (_init), _xi = 0, _xl = _xs.length;      _xi < _xl; ++_xi) _x = _xs[_xi], _x0 = (_f);     return _x0"),ifoldr=form("for (var _xl = _xs.length - 1, _xi = _xl, _x0 = (_init); _xi >= 0; --_xi) _x = _xs[_xi], _x0 = (_f);     return _x0"),iunfold=form("for (var _xr = [], _x = _xs, _xi = 0, _x0;          _x0 = (_init); ++_xi) _xr.push(_x), _x = (_f);       return _xr"),exists=form("for (var _x = _xs[0], _xi = 0, _xl = _xs.length, x; _xi < _xl; ++_xi) {_x = _xs[_xi]; if (x = (_f)) return x} return false"),not_exists=form("for (var _x = _xs[0], _xi = 0, _xl = _xs.length, x; _xi < _xl; ++_xi) {_x = _xs[_xi]; if (x = (_f)) return false} return true"),concat=anon("(S[_xs]).concat((S[_ys]))"),zip=form("for (var _xr = (S[_ys]), pairs = [], i = 0, l = _xs.length; i < l; ++i) pairs.push([_xs[i], _xr[i]]); return pairs"),cross=form("for (var _xr = (S[_ys]), pairs = [], i = 0, l = _xs.length, lj = _xr.length; i < l; ++i) for (var j = 0; j < lj; ++j) pairs.push([_xs[i], _xr[j]]);return pairs"),kmap=form("var _xr = new _xs%%();  for (var _x in _xs) if (#(_xs, _x)) _xr[_f] = _xs[_x]; return _xr"),keach=form("                        for (var _x in _xs) if (#(_xs, _x)) _f;                return _xs"),kfilter=form("var _xr = new _xs%%();    for (var _x in _xs) if (#(_xs, _x) &&      (_f))  _xr[_x] = _xs[_x]; return _xr"),kfilter_not=form("var _xr = new _xs%%();    for (var _x in _xs) if (#(_xs, _x) &&    ! (_f))  _xr[_x] = _xs[_x]; return _xr"),kmap_filter=form("var _xr = new _xs%%(), x; for (var _x in _xs) if (#(_xs, _x) && (x = (_f))) _xr[x]  = _xs[_x]; return _xr"),vmap=form("var _xr = new _xs%%();    for (var  k in _xs) if (#(_xs, k)) _x = _xs[k], _xr[k] = (_f); return _xr"),veach=form("                          for (var  k in _xs) if (#(_xs, k)) _x = _xs[k], _f;            return _xs"),vfilter=form("var _xr = new _xs%%();    for (var  k in _xs) if (#(_xs, k)) _x = _xs[k],        (_f) && (_xr[k] = _x); return _xr"),vfilter_not=form("var _xr = new _xs%%();    for (var  k in _xs) if (#(_xs, k)) _x = _xs[k],        (_f) || (_xr[k] = _x); return _xr"),vmap_filter=form("var _xr = new _xs%%(), x; for (var  k in _xs) if (#(_xs, k)) _x = _xs[k], x = (_f), x && (_xr[k] =  x); return _xr")],word_macros=[rule("S[n[_upper]]",n),rule("S[ni[_upper]]",ni),rule("S[_o /keys]",keys),rule("S[_o |object]",object),rule("S[n[_lower, _upper]]",n),rule("S[ni[_lower, _upper]]",ni),rule("S[_o /values]",values),rule("S[_o -object]",object),rule("S[n[_lower, _upper, _step]]",n),rule("S[ni[_lower, _upper, _step]]",ni),rule("S[_o /pairs]",pairs),rule("S[_o /object]",object)]-where[n(match)=n_pattern.replace($.merge({_lower:"0",_step:"1"},match)),ni(match)=ni_pattern.replace($.merge({_lower:"0",_step:"1"},match)),n_pattern=anon("(function (i, u, s) {if ((u - i) * s <= 0) return [];for (var r = [], d = u - i; d > 0 ? i <  u : i >  u; i += s) r.push(i); return r})((_lower), (_upper), (_step))"),ni_pattern=anon("(function (i, u, s) {if ((u - i) * s <= 0) return [];for (var r = [], d = u - i; d > 0 ? i <= u : i >= u; i += s) r.push(i); return r})((_lower), (_upper), (_step))"),scope=anon("(function (o) {_body}).call(this, (S[_o]))"),scoped(t)=scope.replace({_body:t}),form(p)=tree.replace(match)-given.match-where[tree=scoped(anon(p))],keys=form("var ks = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && ks.push(k); return ks"),values=form("var vs = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && vs.push(o[k]); return vs"),pairs=form("var ps = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && ps.push([k, o[k]]); return ps"),object=form("for (var r = {}, i = 0, l = o.length, x; i < l; ++i) x = o[i], r[x[0]] = x[1]; return r")]]})(caterwaul);caterwaul.js_all=function(){return this.seq(this.words(this.js_literals(this.js())))}})();
(caterwaul.ui_initializer=function(){caterwaul.words(caterwaul.js())(function(a){a.jquery(caterwaul_function)=caterwaul_function-se[it.modifiers.jquery(match)=jquery_expand.call(jquery_expand,anon_pattern.replace({_x:match._expression}))-re-this(it)/when.it]-where[anon_pattern=anon("J[_x]"),jquery_expand=a(a.alternatives(jquery_macros.concat(string_macros).concat(search_macros)))],where[jq="jQuery",anon=a.anonymizer("J","TS","S","P","PS"),hyphenate(s)=s.replace(/_/g,"-"),rule(p,e)=a.rereplacer(anon(p),e.constructor===Function?e.call(this,match)-given.match:anon(e)),p=where[p_pattern=anon("P[_thing]")] in p_pattern.replace({_thing:node})-given.node,jquery_macros=[rule("J[_element]",given.match[match._element.is_constant()||match._element.length?wrap_in_jquery(match):become_dom_node(match)]),rule("J[_element._class]","J[_element].addClass(S[_class])"),rule("J[_element *_attr(_val)]","J[_element].attr(S[_attr], _val)"),rule("J[_element *!_name(_val)]","J[_element].data(S[_name], _val)"),rule("J[_element /_method(_args)]","J[_element]._method(_args)"),rule("J[_element /!_event(_args)]","J[_element].bind(S[_event], _args)"),rule("J[_element %_function]","_function(J[_element])"),rule("J[_element(_children)]","J[_element].append(J[_children])"),rule("J[_element[_children]]","J[_element].append(_children)"),rule("J[_element < _tree]","J[_element].append((_tree).toString())"),rule("J[_element > _child]","J[_element].append(J[_child])"),rule("J[_element >= _child]","J[_element].append(_child)"),rule("J[_element1, _element2]","J[_element1].add(J[_element2])"),rule("J[_element1 + _element2]","J[_element1].add(J[_element2])"),rule("J[_element >> _pattern]","J[_element].filter(PS[_pattern])"),rule("J[_element >>> _pattern]","J[_element].find(PS[_pattern])"),rule("J[_element << _pattern]","J[_element].parents(PS[_pattern])"),rule("J[(_element)]","(J[_element])"),rule("J[[_element]]","[J[_element]]"),rule("J[+_expression]","_expression")]-where[dom_node_template=anon("#{jq}(TS[_element])"),jquery_template=anon('#{jq}("<span>" + (_element) + "</span>")'),become_dom_node(match)=dom_node_template.replace(match),wrap_in_jquery(match)=jquery_template.replace(match)],string_macros=[rule("TS[_identifier]",string("<#{hyphenate(match._identifier.data)}>")-given.match),rule("S[_identifier]",string(hyphenate(match._identifier.data))-given.match),rule("PS[_identifier]",string(expand(p(match._identifier)).data)-given.match)]-where[string(s)=new a.syntax('"'+s.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"')],search_macros=[rule("P[_element]",new a.syntax(hyphenate(match._element.data-re[it==="_"?"*":it]))-given.match),rule("P[_element._class]",new a.syntax("#{this(p(match._element)).data}.#{hyphenate(match._class.data)}")-given.match),rule("P[_element[_attributes]]",new a.syntax("#{this(p(match._element)).data}[#{this(p(match._attributes))}]")-given.match),rule("P[_attribute = _value]",new a.syntax('#{this(p(match._attribute)).data}="#{'+interpolated(match._value)+'}"')-given.match),rule("P[(_element)]","P[_element]"),rule("P[_element1 +   _element2]",binary(", ")),rule("P[_element1,    _element2]",binary(", ")),rule("P[_element1 >>  _element2]",binary(" ")),rule("P[_element1 >>> _element2]",binary(" ")),rule("P[_element1 >   _element2]",binary(" > ")),rule("P[_element1(_element2)]",binary(" > ")),rule("P[_element /_selector]",new a.syntax("#{expand(p(match._element)).data}:#{hyphenate(match._selector.data)}")-given.match),rule("P[_element /_selector(_value)]",new a.syntax('#{expand(p(match._element)).data}:#{hyphenate(match._selector.data)}("#{'+interpolated(match._value)+'}")')-given.match)]-where[interpolated(node)='(#{node.toString()}).replace(/(\\)/g, "$1$1").replace(/(")/g, "\\$1")',binary(op)(match)=new a.syntax("#{expand(p(match._element1)).data}#{op}#{expand(p(match._element2)).data}")]]})(caterwaul)})();

caterwaul('js_all')(function ($) {
  options.input_files *!waul -seq
  -where [fs                         = require('fs'),
          options                    = {extensions: [], input_files: [], use_std: true, compile: ! /waulrun$/.test(process.argv[1])}
                                       -se [it.input_files = [process.argv[2]], unless [it.compile]]
                                       -se- process.argv.slice(2) *![x === '--extension' ? it.extensions /~push/ xs[++xi]              :
                                                                     x === '--run'       ? it.compile = !(it.input_files = [xs[++xi]]) :
                                                                     x === '--no-std'    ? it.use_std = false                          : it.input_files /~push/ x -when- it.compile] /seq,

          build_caterwaul            = $()('(function () {(function (f) {return f(f)})(#{$.initializer});\n' +
                                                          (options.use_std ? '(caterwaul.std_initializer = #{$.std_initializer})();\n' +
                                                                             '(caterwaul.ui_initializer  = #{$.ui_initializer})();\n' : '') +
                                                          options.extensions *[fs.readFileSync(x, 'utf8')] /seq /re [it.join(';\n') + ';\nreturn caterwaul.deglobalize()})']),

          waul(file)                 = options.compile ? fs.writeFileSync(file.replace(/\.waul$/, '.js'), waul_transform(fs.readFileSync(file, 'utf8') /!$.parse).toString(), 'utf8')
                                                       : waul_run(fs.readFileSync(file, 'utf8') /!$.parse),

          waul_transform(tree)       = flat[1] / flat[2] /-toplevel/ flat[3] -where [flat = tree[0].flatten('()')],
          waul_run(tree)             = caterwaul.compile(tree[0], {require: require, caterwaul: caterwaul}) -where [caterwaul = build_caterwaul()],

          toplevel(conf, tree, args) = caterwaul(conf.as_escaped_string())(tree) -re- qs[(_x)(_y)] /~replace/ {_x: it /!caterwaul.late_bound_tree, _y: args}
                               -where [caterwaul = build_caterwaul()]]}, {require: require})(caterwaul);

// Generated by SDoc 
