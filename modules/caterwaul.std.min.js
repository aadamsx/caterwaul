// Caterwaul JS | Spencer Tipping
// Licensed under the terms of the MIT source code license
caterwaul.configuration('std.qs',function (){this.macro(this.parse('qs[_]'),function (tree){return new this.ref(tree)}).macro(this.parse('qse[_]'),function (tree){return new this.ref(this.macroexpand(tree))}).macro(this.parse('literal[_]'),function (tree){return tree})}).tconfiguration('std.qs','std.qg',function (){this.rmacro(qs[qg[_]],function (expression){return expression.as('(')})}).tconfiguration('std.qs std.qg','std.fn',function (){this.rmacro(qs[fn[_][_]],function (vars,expression){return qse[qg[function (vars){return expression}]].replace({vars:vars,expression:expression})}).rmacro(qs[fn_[_]],function (expression){return qse[qg[function (){return expression}]].replace({expression:expression})})}).tconfiguration('std.qs std.qg std.fn','std.fb',function (){this.rmacro(qs[fb[_][_]],function (vars,expression){return qse[fn[_t][fn_[fn[vars][e].apply(_t,arguments)]](this)].replace({_t:this.gensym(),vars:vars,e:expression})}).rmacro(qs[fb_[_]],function (expression){return qse[fn[_t][fn_[fn_[e].apply(_t,arguments)]](this)].replace({_t:this.gensym(),e:expression})})}).tconfiguration('std.qs std.qg std.fn','std.fc',function (){this.rmacro(qs[fc[_][_]],function (vars,body){return qse[qg[fn[vars][body,undefined]]].replace({vars:vars,body:body})}).rmacro(qs[fc_[_]],function (body){return qse[qg[fn[vars][body,undefined]]].replace({body:body})})}).tconfiguration('std.qs std.qg std.fn','std.mb',function (){this.rmacro(qs[_/mb/_],fn[o,m][qse[qg[fn[_o][_o.m&&fn_[_o.m.apply(_o,arguments)]]](o)].replace({_o:this.gensym(),o:o,m:m})]).rmacro(qs[_/mb[_]],fn[o,m][qse[qg[fn[_o,_m][_o[_m]&&fn_[_o[_m].apply(_o,arguments)]]](o,m)].replace({_o:this.gensym(),_m:this.gensym(),o:o,m:m})])}).tconfiguration('std.qs std.qg std.fn','std.se',function (){this.rmacro(qs[_/se._[_]],fn[v,n,b][qse[qg[fn[n][b,n]].call(this,v)].replace({b:b,n:n,v:v})]).rmacro(qs[_/se[_]],fn[v,b][qse[v/se._[b]].replace({b:b,v:v})]).rmacro(qs[_/re._[_]],fn[v,n,b][qse[qg[fn[n][b]].call(this,v)].replace({b:b,n:n,v:v})]).rmacro(qs[_/re[_]],fn[v,b][qse[v/re._[b]].replace({b:b,v:v})])}).tconfiguration('std.qs std.qg std.fn','std.bind',function (){var l_star_expander=fb[vars,expression][qs[qg[function (){var vars;
return expression}].call(this)].replace({vars:this.macroexpand(vars),expression:expression})],l_expander=fb[vars,expression][vars=this.macroexpand(vars).flatten(','),qse[qg[fn[vars][e]].call(this,values)].replace({vars:vars.map(fn[n][n[0]]).unflatten(),e:expression,values:vars.map(fn[n][n[1]]).unflatten()})];
this.rmacro(qs[l[_] in _],qs[l[_][_]],l_expander).rmacro(qs[_,where[_]],qs[_/where[_]],fn[e,vs][l_expander(vs,e)]).rmacro(qs[l*[_] in _],qs[l*[_][_]],l_star_expander).rmacro(qs[_,where*[_]],qs[_/where*[_]],fn[e,vs][l_star_expander(vs,e)])}).tconfiguration('std.qs std.qg std.fn','std.lvalue',function (){this.rmacro(qs[_(_)=_],fn[l,xs,v][qse[_l=qg[fn[_xs][_v]]].replace({_l:l,_xs:xs,_v:v})])}).tconfiguration('std.qs std.qg std.fn','std.cond',function (){this.rmacro(qs[_,when[_]],qs[_/when[_]],fn[expr,cond][qse[qg[l]&&qg[r]].replace({l:cond,r:expr})]).rmacro(qs[_,unless[_]],qs[_/unless[_]],fn[expr,cond][qse[ !qg[l]&&qg[r]].replace({l:cond,r:expr})])}).tconfiguration('std.qs std.qg std.fn','std.ref',function (){this.macro(qs[caterwaul],fn_[new this.ref(this)])}).tconfiguration('std.qs std.fn std.bind','std.string',function (){this.rmacro(qs[_],fn[string][string.is_string()&&/#\{[^\}]+\}/.test(string.data)&&l*[q=string.data.charAt(0),s=string.as_escaped_string(),eq=new RegExp('\\\\'+q,'g'),strings=s.split(/#\{[^\}]+\}/),xs=[],result=new this.syntax('+')][s.replace(/#\{([^\}]+)\}/g,fn[_,s][xs.push(s),'']),this.util.map(fb[x,i][result.push(new this.syntax(q+(i<strings.length?strings[i]:'')+q)).push(new this.syntax('(',this.parse(xs[i].replace(eq,q))))],xs),new this.syntax('(',result.push(new this.syntax(q+(xs.length<strings.length?strings[strings.length-1]:'')+q)).unflatten())]])}).tconfiguration('std.qs','std.using',function (){this.rmacro(qs[using[_] in _],qs[using[_][_]],fn[os,body][])}).configuration('std',function (){this.configure('std.qs std.qg std.bind std.lvalue std.cond std.fn std.mb std.se std.ref std.string std.using')});
