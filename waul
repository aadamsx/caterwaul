#!/usr/bin/env node

// Waul: the offline precompiler for Caterwaul | Spencer Tipping
// Licensed under the terms of the MIT source code license

// Introduction.
// Caterwaul is useful as a library and an online compiler, but when performance is important you probably want to deliver precompiled code. Waul is a program that does exactly that. You write a
// regular file that invokes Caterwaul on a function, and Waul emits a Javascript file that contains the Caterwaul-compiled results. For example:

// | $ cat > test.waul <<EOF
//   caterwaul('js_all')(function ($) {
//     console.log('#{message} from caterwaul!')
//     -where [message = 'hello']})(caterwaul);
//   EOF
//   $ waul test.waul
//   $ node test.js
//   hello from caterwaul!
//   $

// Waul has some limitations:

// | 1. It cannot precompile any macros that generate refs (this includes the -eval- modifier, unfortunately, though as of 1.1.6 -using- works just fine).
//   2. You need to inform it about any Caterwaul extensions up-front (I'll explain how to do this).

// Extensions.
// Caterwaul can be extended with custom macros, and in order to precompile something that uses these extensions you'll have to inform Waul about them. You can do this with the --extension flag,
// like this:

// | $ waul --extension caterwaul.custom.js foo.waul

// This will result in Waul loading in the custom extensions before customizing the Caterwaul instance that is used inside foo.waul. Waul comes with the standard library built-in, but you can
// disable it:

// | $ waul --no-std foo.waul                              # just use Caterwaul core

// You can compile multiple files at once using multiple arguments. If you do this, each will be compiled to its own .js file.

// Dependencies.
// This program depends on Caterwaul, which is baked in minified here. It includes the 'ui' library even though Waul itself doesn't use it. The reason is that Waul scripts are allowed to, so Waul
// needs to be prepared to precompile things that depend on it.

(function(a){return a(a)})(function(ar,ab,x){var e=function(aw){return aw.split(/\s+/)},ah=function(aw,ax){return ax&&ax.call(aw,aw)||aw},c=function(aw){throw new Error(aw)},u=ab||(function(){for(var aw=[],ay="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789$_",ax=21,az;ax>=0;--ax){aw.push(ay.charAt(Math.random()*64>>>0))}return aw.join("")})(),j=(function(aw){return function(ax){return[ax||"",(++aw).toString(36),u].join("_")}})(0),f=function(aw){return aw.substr(aw.length-22)===u},an=function(ax,aw){return function(){return ax.apply(aw,arguments)}},y=function(aA,ax){for(var ay=0,az=[],aw=ax.length;ay<aw;++ay){az.push(aA(ax[ay],ay))}return az},v=function(ax,aw){return y(function(ay){return ay instanceof Array?v(ax,ay):ax(ay)})},L=function(az){for(var ay=0,ax=e(az),aA={},aw=ax.length;ay<aw;++ay){aA[ax[ay]]=true}return af(aA)},z=(function(ax){for(var aw in ax){if(ax.hasOwnProperty(aw)){return true}}})({toString:true})?function(aA){for(var az=1,aw=arguments.length,ay;az<aw;++az){if(ay=arguments[az]){for(var ax in ay){if(G(ay,ax)){aA[ax]=ay[ax]}}}}return aA}:function(aA){for(var az=1,aw=arguments.length,ay;az<aw;++az){if(ay=arguments[az]){for(var ax in ay){if(G(ay,ax)){aA[ax]=ay[ax]}}if(ay.toString&&!/\[native code\]/.test(ay.toString.toString())){aA.toString=ay.toString}}}return aA},a=j("hash"),af=function(ay){var aw=0;for(var ax in ay){ac.call(ay,ax)&&(aw=ax.length>aw?ax.length:aw)}ay[a]=aw;return ay},G=function(ax,aw){return aw!=null&&!(aw.length>ax[a])&&ac.call(ax,aw)},ac=Object.prototype.hasOwnProperty,W=function(){var aw=function(){return aw.init.apply(aw,arguments)};return aw},E=typeof caterwaul==="undefined"?x:caterwaul,H=ah(W(),function(){this.deglobalize=function(){caterwaul=E;return H};z(this,{merge:z,map:y,rmap:v,gensym:j,is_gensym:f})}),D=L(". new ++ -- u++ u-- u+ u- typeof u~ u! ! * / % + - << >> >>> < > <= >= instanceof in == != === !== & ^ | && || ? = += -= *= /= %= &= |= ^= <<= >>= >>>= : , return throw case var const break continue void else u; ;"),ag=function(az){for(var ay=0,ax=[false];ay<8;++ay){ax.push.apply(ax,ax)}for(var ay=0,aw=az.length;ay<aw;++ay){ax[az.charCodeAt(ay)]=true}return ax},au=ag(".0123456789"),ak=ag("0123456789"),Y=ag("0123456789abcdefABCDEFx"),h=ag("eE"),ai=ag(" \n\r\t"),al=ag("()[]{}?:"),am=ag("([{?:"),g=ag("+-*/%&|^!~=<>?:;.,"),T=ag("\n\r"),K=ag("gims"),o=ag("'\"/"),l="/".charCodeAt(0),i="0".charCodeAt(0),A=L("++ --"),J=ag("$_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),q="*".charCodeAt(0),d="\\".charCodeAt(0),M="x".charCodeAt(0),R=".".charCodeAt(0),Z="#".charCodeAt(0),ap=y(L,["function","( [ . [] ()","new delete","u++ u-- ++ -- typeof u~ u! u+ u-","* / %","+ -","<< >> >>>","< > <= >= instanceof in","== != === !==","&","^","|","&&","||","case","? = += -= *= /= %= &= |= ^= <<= >>= >>>=",":",",","return throw break continue void","var const","if else try catch finally for switch with while do",";"]),t=L("= += -= *= /= %= &= ^= |= <<= >>= >>>= ~ ! new typeof u+ u- -- ++ u-- u++ ? if else function try catch finally for switch case with while do"),B=(function(ay){for(var aA={},az=0,aw=ay.length;az<aw;++az){for(var ax in ay[az]){G(ay[az],ax)&&(aA[ax]=az)}}return af(aA)})(ap),U=(function(ay){for(var aA=[],aB=0,aw=ay.length,az=null;az=ay[aB],aA[aB]=true,aB<aw;++aB){for(var ax in az){if(G(az,ax)&&(aA[aB]=aA[aB]&&!G(t,ax))){break}}}return aA})(ap),aa=L("[] . () * / % + - << >> >>> < > <= >= instanceof in == != === !== & ^ | && || = += -= *= /= %= &= |= ^= <<= >>= >>>= , : ;"),m=af({"function":2,"if":1,"do":1,"catch":1,"try":1,"for":1,"while":1,"with":1,"switch":1}),r=af({"if":"else","do":"while","catch":"finally","try":"catch"}),X=L("[] ()"),av=L("return throw break continue else"),O=L("u+ u- u! u~ u++ u-- new typeof finally case var const void delete"),ae=L("; {"),V=L("i;"),P=L("++ --"),at=af({"(":")","[":"]","{":"}","?":":"}),Q=L("[ ("),w=L("?"),I=L("function if for while catch void delete new typeof in instanceof"),S=L("function"),n=H.syntax_common={_replace:function(aw){return(aw.l=this.l)&&(this.l.r=aw),(aw.r=this.r)&&(this.r.l=aw),this},_append_to:function(aw){return aw&&aw._append(this),this},_reparent:function(aw){return this.p&&this.p[0]===this&&(this.p[0]=aw),this},_fold_l:function(aw){return this._append(this.l&&this.l._unlink(this)||aj)},_append:function(aw){return(this[this.length++]=aw)&&(aw.p=this),this},_fold_r:function(aw){return this._append(this.r&&this.r._unlink(this)||aj)},_sibling:function(aw){return aw.p=this.p,(this.r=aw).l=this},_fold_lr:function(){return this._fold_l()._fold_r()},_fold_rr:function(){return this._fold_r()._fold_r()},_wrap:function(aw){return aw.p=this._replace(aw).p,this._reparent(aw),delete this.l,delete this.r,this._append_to(aw)},_unlink:function(aw){return this.l&&(this.l.r=this.r),this.r&&(this.r.l=this.l),delete this.l,delete this.r,this._reparent(aw)},pop:function(){return --this.length,this},push:function(aw){return this[this.length++]=aw||aj,this},id:function(){var aw=j("id");return(this.id=function(){return aw})()},is_caterwaul_syntax:true,each:function(ay){for(var ax=0,aw=this.length;ax<aw;++ax){ay(this[ax],ax)}return this},map:function(ay){for(var az=new this.constructor(this),ax=0,aw=this.length;ax<aw;++ax){az.push(ay(this[ax],ax)||this[ax])}return az},reach:function(aw){aw(this);this.each(function(ax){ax.reach(aw)});return this},rmap:function(ax){var aw=ax(this);return !aw||aw===this?this.map(function(ay){return ay.rmap(ax)}):aw===true?this:aw.rmap===x?new this.constructor(aw):aw},peach:function(aw){this.each(function(ax){ax.peach(aw)});aw(this);return this},pmap:function(ax){var aw=this.map(function(ay){return ay.pmap(ax)});return ax(aw)},clone:function(){return this.rmap(function(){return false})},collect:function(ax){var aw=[];this.reach(function(ay){ax(ay)&&aw.push(ay)});return aw},replace:function(aw){var ax;return ac.call(aw,this.data)&&(ax=aw[this.data])?ax.constructor===String?ah(this.map(function(ay){return ay.replace(aw)}),function(){this.data=ax}):ax:this.map(function(ay){return ay.replace(aw)})},repopulated_with:function(aw){return new this.constructor(this.data,aw)},with_data:function(aw){return new this.constructor(aw,Array.prototype.slice.call(this))},change:function(ax,aw){return ah(new this.constructor(this.data,Array.prototype.slice.call(this)),function(ay){ay[ax]=aw})},compose_single:function(aw,ax){return this.change(aw,ax(this[aw]))},slice:function(ax,aw){return new this.constructor(this.data,Array.prototype.slice.call(this,ax,aw))},traverse:function(aw){aw({entering:this});aw({exiting:this.each(function(ax){ax.traverse(aw)})});return this},flatten:function(aw){aw=aw||this.data;return aw!==this.data?this.as(aw):!(G(aa,aw)&&this.length)?this:G(t,aw)?ah(new this.constructor(aw),an(function(ay){for(var ax=this;ax&&ax.data===aw;ax=ax[1]){ay.push(ax[0])}ay.push(ax)},this)):ah(new this.constructor(aw),an(function(az){for(var ax=this,ay=[];ax.data===aw;ax=ax[0]){ax[1]&&ay.push(ax[1])}ay.push(ax);for(ax=ay.length-1;ax>=0;--ax){az.push(ay[ax])}},this))},unflatten:function(){var ax=this,aw=G(t,this.data);return this.length<=2?this:ah(new this.constructor(this.data),function(aA){if(aw){for(var az=0,ay=ax.length-1;az<ay;++az){aA=aA.push(ax[az]).push(az<ay-2?new ax.constructor(ax.data):ax[az])[1]}}else{for(var az=ax.length-1;az>=1;--az){aA=aA.push(az>1?new ax.constructor(ax.data):ax[0]).push(ax[az])[0]}}})},as:function(aw){return this.data===aw?this:new this.constructor(aw).push(this)},bindings:function(ax){var aw=ax||{};this.reach(function(ay){if(ay.binds_a_value){aw[ay.data]=ay.value}});return aw},expressions:function(ax){var aw=ax||{};this.reach(function(ay){if(ay.binds_an_expression){aw[ay.data]=ay.e}});return aw},contains:function(az){var aw=az(this);if(aw){return aw}for(var ay=0,ax=this.length;ay<ax;++ay){if(aw=this[ay].contains(az)){return aw}}},match:function(ay,az){ay=ay.constructor===String?H.parse(ay):ay;az||(az={_:ay});if(this.is_wildcard()){return az[this.data]=ay,az}else{if(this.length===ay.length&&this.data===ay.data){for(var ax=0,aw=this.length;ax<aw;++ax){if(!this[ax].match(ay[ax],az)){return null}}return az}}},toString:function(){var aw=[""];this.serialize(aw);return aw.join("")},structure:function(){if(this.length){return"("+['"'+this.data+'"'].concat(y(function(aw){return aw.structure()},this)).join(" ")+")"}else{return this.data}}};H.syntax_subclass=function(ay){var ax=Array.prototype.slice.call(arguments,1),aw=function(){return ay.apply(this,arguments)};z.apply(this,[aw.prototype,n].concat(ax));aw.prototype.constructor=aw;return aw};var N=H.parse_hex=function(az){for(var aw=0,ay=0,ax=az.length,aA;ay<ax;++ay){aw*=16,aw+=(aA=az.charCodeAt(ay))<=58?aA-48:(aA&95)-55}return aw},s=H.parse_octal=function(az){for(var aw=0,ay=0,ax=az.length;ay<ax;++ay){aw*=8,aw+=az.charCodeAt(ay)-48}return aw},aq=H.unescape_string=function(aA){for(var az=0,aB,ax=aA.length,aw=[],ay=false;az<ax;++az){if(ay){ay=false,aw.push((aB=aA.charAt(az))==="\\"?"\\":aB==="n"?"\n":aB==="r"?"\r":aB==="b"?"\b":aB==="f"?"\f":aB==="0"?"\u0000":aB==="t"?"\t":aB==="v"?"\v":aB==='"'||aB==="'"?aB:aB==="x"?String.fromCharCode(N(aA.substring(az,++az+1))):aB==="u"?String.fromCharCode(N(aA.substring(az,(az+=3)+1))):String.fromCharCode(s(aA.substring(az,(az+=2)+1))))}else{if((aB=aA.charAt(az))==="\\"){ay=true}else{aw.push(aB)}}}return aw.join("")};H.javascript_tree_type_methods={is_string:function(){return/['"]/.test(this.data.charAt(0))},as_escaped_string:function(){return this.data.substr(1,this.data.length-2)},is_number:function(){return/^-?(0x|\d|\.\d+)/.test(this.data)},as_number:function(){return Number(this.data)},is_boolean:function(){return this.data==="true"||this.data==="false"},as_boolean:function(){return this.data==="true"},is_regexp:function(){return/^\/./.test(this.data)},as_escaped_regexp:function(){return this.data.substring(1,this.data.lastIndexOf("/"))},is_array:function(){return this.data==="["},as_unescaped_string:function(){return aq(this.as_escaped_string())},is_wildcard:function(){return this.data.charCodeAt(0)===95},is_identifier:function(){return this.length===0&&/^[A-Za-z_$]\w*$/.test(this.data)&&!this.is_boolean()&&!this.is_null_or_undefined()&&!G(D,this.data)},has_grouped_block:function(){return G(m,this.data)},is_block:function(){return G(ae,this.data)},is_blockless_keyword:function(){return G(av,this.data)},is_null_or_undefined:function(){return this.data==="null"||this.data==="undefined"},is_constant:function(){return this.is_number()||this.is_string()||this.is_boolean()||this.is_regexp()||this.is_null_or_undefined()},left_is_lvalue:function(){return/=$/.test(this.data)||/\+\+$/.test(this.data)||/--$/.test(this.data)},is_empty:function(){return !this.length},has_parameter_list:function(){return this.data==="function"||this.data==="catch"},has_lvalue_list:function(){return this.data==="var"||this.data==="const"},is_dereference:function(){return this.data==="."||this.data==="[]"},is_invocation:function(){return this.data==="()"},is_contextualized_invocation:function(){return this.is_invocation()&&this[0].is_dereference()},is_invisible:function(){return G(V,this.data)},is_binary_operator:function(){return G(aa,this.data)},is_prefix_unary_operator:function(){return G(O,this.data)},is_postfix_unary_operator:function(){return G(P,this.data)},is_unary_operator:function(){return this.is_prefix_unary_operator()||this.is_postfix_unary_operator()},accepts:function(aw){return G(r,this.data)&&r[this.data]===(aw.data||aw)}};H.javascript_tree_serialization_methods={ends_with_block:function(){var aw=this[m[this.data]];return this.data==="{"||G(m,this.data)&&(this.data!=="function"||this.length===3)&&aw&&aw.ends_with_block()},serialize:function(az){var ax=this.length,aA=this.data,aw=";\n",ay=function(aB){if(J[az[az.length-1].charCodeAt(0)]===J[aB.charCodeAt(0)]){az.push(" ",aB)}else{az.push(aB)}};switch(ax){case 0:if(G(av,aA)){return ay(aA.replace(/^u/,""))}else{if(G(at,aA)){return ay(aA),ay(at[aA])}else{return ay(aA)}}case 1:if(G(O,aA)||G(av,aA)){return ay(aA.replace(/^u/,"")),this[0].serialize(az)}else{if(G(at,aA)){return ay(aA),this[0].serialize(az),ay(at[aA])}else{if(G(aa,aA)){return ay("/* unary "+aA+" node */"),this[0].serialize(az)}else{return this[0].serialize(az),ay(aA)}}}case 2:if(G(X,aA)){return this[0].serialize(az),ay(aA.charAt(0)),this[1].serialize(az),ay(aA.charAt(1))}else{if(G(m,aA)){return ay(aA),this[0].serialize(az),this[1].serialize(az)}else{if(G(V,aA)){return this[0].serialize(az),this[1].serialize(az)}else{if(aA===";"){return this[0].serialize(az),ay(aw),this[1].serialize(az)}else{return this[0].serialize(az),ay(aA),this[1].serialize(az)}}}}default:if(G(w,aA)){return this[0].serialize(az),ay(aA),this[1].serialize(az),ay(":"),this[2].serialize(az)}else{if(G(m,aA)){return this.accepts(this[2])&&!this[1].ends_with_block()?(ay(aA),this[0].serialize(az),this[1].serialize(az),ay(aw),this[2].serialize(az)):(ay(aA),this[0].serialize(az),this[1].serialize(az),this[2].serialize(az))}else{return this.unflatten().serialize(az)}}}}};H.ref_common=z({},H.javascript_tree_type_methods,H.javascript_tree_serialization_methods,{replace:function(aw){var ax;return ac.call(aw,this.data)&&(ax=aw[this.data])?ax.constructor===String?ah(new this.constructor(this.value),function(){this.data=ax}):ax:this},length:0});H.ref=H.syntax_subclass(function(ax,aw){if(ax instanceof this.constructor){this.value=ax.value,this.data=ax.data}else{this.value=ax,this.data=j(aw&&aw.constructor===String?aw:"ref")}},H.ref_common,{binds_a_value:true});H.expression_ref=H.syntax_subclass(function(ax,aw){if(ax instanceof this.constructor){this.e=ax.e,this.data=ax.data}else{this.e=ax,this.data=j(aw&&aw.constructor===String?aw:"e")}},H.ref_common,{binds_an_expression:true});H.syntax=H.syntax_subclass(function(aB){if(aB instanceof this.constructor){this.data=aB.data,this.length=0}else{this.data=aB&&aB.toString();this.length=0;for(var az=1,aw=arguments.length,ay;ay=arguments[az],az<aw;++az){for(var ax=0,aD=ay.length,aA,aC;ay instanceof Array?(aA=ay[ax],ax<aD):(aA=ay,!ax);++ax){this._append((aC=aA.constructor)===String||aC===Number||aC===Boolean?new this.constructor(aA):aA)}}}},H.javascript_tree_type_methods,H.javascript_tree_serialization_methods);var aj=H.empty=new H.syntax("");H.parse=function(aw){if(aw.constructor===H.syntax){return aw}var aR=aw.toString(),aB=0,a3=0,aO=true,aN=false,a5=false,a4=false,aS=0,aP="",a0=0,aX=aR.length,aI=function(a7){return aR.charCodeAt(a7)},aG=[],aW=null,aE=null,aC=null,ax=y(function(){return[]},ap),aD=[],aQ=[aj],aY=function(a7){return aQ.push(a7),a7},aT=function(a7){return aE?aE._sibling(aE=a7):(aE=a7._append_to(aC)),aY(a7)},ay=this.syntax,aF=[];if(aX===0){return aj}while((aB=a0)<aX){while(ai[a3=aI(a0)]&&a0<aX){aB=++a0}aN=a4=a5=aP=false;if(al[a3]){aP=!!++a0;aO=am[a3]}else{if(a3===l&&aI(a0+1)===q&&(a0+=2)){while(++a0<aX&&aI(a0)!==l||aI(a0-1)!==q){}aP=!++a0}else{if(a3===l&&aI(a0+1)===l){while(++a0<aX&&!T[aI(a0)]){}aP=false}else{if(a3===Z){while(++a0<aX&&!T[aI(a0)]){}aP=false}else{if(o[a3]&&(aS=a3)&&aO&&!(aO=!(aP=aR.charAt(a0)))){while(++a0<aX&&(a3=aI(a0))!==aS||aN){aN=!aN&&a3===d}while(++a0<aX&&K[aI(a0)]){}aP=true}else{if(a3===i&&Y[aI(a0+1)]){while(++a0<aX&&Y[aI(a0)]){}aO=!(aP=true)}else{if(au[a3]&&(a3!==R||ak[aI(a0+1)])){while(++a0<aX&&(ak[a3=aI(a0)]||(a5^(a5|=a3===R))||(a4^(a4|=h[a3]&&++a0)))){}while(a0<aX&&ak[aI(a0)]){++a0}aO=!(aP=true)}else{if(g[a3]&&(aP=aO?"u":"",aO=true)){while(a0<aX&&g[aI(a0)]&&G(D,aP+aR.charAt(a0))){aP+=aR.charAt(a0++)}aO=!G(A,aP)}else{while(++a0<aX&&(J[a3=aI(a0)]||a3>127)){}aO=G(D,aP=aR.substring(aB,a0))}}}}}}}}if(a0===aB){throw new Error('Caterwaul lex error at "'+aR.substr(aB,40)+'" with leading context "'+aR.substr(aB-40,40)+'" (probably a Caterwaul bug)')}if(aP===false){continue}aP=aP===true?aR.substring(aB,a0):aP==="u;"?";":aP;aP===aW?(aG.pop(),aW=aG[aG.length-1],aE=aE?aE.p:aC,aC=null):(G(at,aP)?(aG.push(aW=at[aP]),aC=aT(aY(new ay(aP))),aE=null):aT(aY(new ay(aP))),G(B,aP)&&ax[B[aP]].push(aE||aC));aO|=aP===")"&&aE.l&&G(m,aE.l.data)}for(var a0=0,aX=ax.length,aM,a6;a6=ax[a0],aM=U[a0],a0<aX;++a0){for(var aZ=aM?0:a6.length-1,aL=a6.length,a1=aM?1:-1,aJ,a2,aK;aM?aZ<aL:aZ>=0;aZ+=a1){if(G(aa,a2=(aJ=a6[aZ]).data)){aJ._fold_lr()}else{if(G(Q,a2)&&aJ.l&&!((aK=aJ.l.l)&&G(m,aK.data))&&(aJ.l.data==="."||(aJ.l.data==="function"&&aJ.l.length===2)||!(G(D,aJ.l.data)||G(I,aJ.l.data)))){aD.push(aJ.l._wrap(aY(new ay(a2+at[a2]))).p._fold_r())}else{if(G(P,a2)){aJ._fold_l()}else{if(G(O,a2)){aJ._fold_r()}else{if(G(w,a2)){aJ._fold_lr(),aF.push(aJ)}else{if(G(m,a2)&&aJ.r&&aJ.r.data!==":"){for(var aU=0,aH=m[a2];aU<aH&&aJ.r&&!G(ae,aJ.r.data);++aU){aJ._fold_r()}aJ.r&&(aJ.r.data===";"?aJ.push(aj):aJ._fold_r());if(G(r,a2)&&r[a2]===(aJ.r&&aJ.r.r&&aJ.r.r.data)){aJ._fold_r().pop()._fold_r()}else{if(G(r,a2)&&r[a2]===(aJ.r&&aJ.r.data)){aJ._fold_r()}}}else{if(G(av,a2)){aJ.r&&aJ.r.data!==";"&&aJ._fold_r()}}}}}}}}}for(var a0=aQ.length-1,a6;a0>=0;--a0){(a6=aQ[a0]).r&&a6._wrap(aY(new ay("i;"))).p._fold_r()}for(var a0=0,aX=aD.length,a6,az;a0<aX;++a0){(az=(a6=aD[a0])[1]=a6[1][0]||aj)&&(az.p=a6)}for(var a0=0,aX=aF.length,a6,aV,aA;a0<aX;++a0){aV=(a6=aF[a0]).length,aA=a6[0],a6[0]=a6[aV-2],a6[1]=aA,a6[2]=a6[aV-1],a6.length=3}while(aE.p){aE=aE.p}for(var a0=aQ.length-1,a6;a0>=0;--a0){delete (a6=aQ[a0]).p,delete a6.l,delete a6.r}return aE};var ad=H.parse("var _bindings; return(_expression)"),p=H.parse("_variable = _base._variable"),k=H.parse("undefined = void(0)"),C=H.parse("(function (_bindings) {return(_body)}).call(this, _expressions)");H.compile=function(aH,aB,aG){aG=z({gensym_renaming:true},aG);aH=H.late_bound_tree(aH);var ay=z({},this._environment||{},aB||{},aH.bindings()),aD=[k],aF=j("base");for(var aA in ay){if(ac.call(ay,aA)&&aA!=="this"){aD.push(p.replace({_variable:aA,_base:aF}))}}var aE=new this.syntax(",",aD).unflatten(),aw=ad.replace({_bindings:aE,_expression:aH});if(aG.gensym_renaming){var az=this.gensym_rename_table(aw);for(var aA in ay){ac.call(ay,aA)&&(ay[az[aA]||aA]=ay[aA])}aw=aw.replace(az);aF=az[aF]}var ax=aw.toString();try{return(new Function(aF,ax)).call(ay["this"],ay)}catch(aC){throw new Error((aC.message||aC)+" while compiling "+ax)}};H.late_bound_tree=function(ax,aw){var aB=z({},aw||{},ax.expressions()),aA=new H.syntax(","),az=new H.syntax(",");for(var ay in aB){if(ac.call(aB,ay)){aA.push(new H.syntax(ay)),az.push(aB[ay])}}return aA.length?C.replace({_bindings:aA.unflatten(),_expressions:az.unflatten(),_body:ax}):ax};H.gensym_rename_table=function(aE){var aD={},aB=[];aE.reach(function(aF){var aG=aF.data;if(f(aG)){aD[aG]||aB.push(aG)}aD[aG]=aG.replace(/^(.*)_[a-z0-9]+_.{22}$/,"$1")||"anon"});var aw={},aC=function(aF){if(!(aF in aD)){return aF}var aG=aw[aF]||0;while(aD[aF+(++aG).toString(36)]){}return aF+(aw[aF]=aG).toString(36)};for(var ax={},az=0,ay=aB.length,aA;az<ay;++az){ax[aA=aB[az]]||(aD[ax[aA]=aC(aD[aA])]=true)}return ax};var b=function(ax){for(var ay=ax.split(/\s+/),az=1,aw=ay.length,aA=H[ay[0]]();az<aw;++az){aA=H[ay[az]](aA)}return aA};H.init=function(aw){aw||(aw=function(ax){return true});return aw.constructor===Function?ah((function(){var ax=function(aA,ay,az){return typeof aA==="function"||aA.constructor===String?H.compile(ax.call(ax,H.parse(aA)),ay,az):aA.rmap(function(aB){return aw.call(ax,aB,ay,az)})};return ax})(),function(){this.global=H,this.macroexpander=aw}):b(aw)};H.initializer=ar;H.clone=function(){return ah(ar(ar,u).deglobalize(),function(){for(var aw in H){this[aw]||(this[aw]=H[aw])}})};H.modules=[];H.module=function(ax,aw,ay){if(arguments.length===1){return H[ax+"_initializer"]}if(!(ax+"_initializer" in H)){H.modules.push(ax)}ay||(ay=aw,aw=null);(H[ax+"_initializer"]=aw?H(aw)(ay):ay)(H);return H};var ao=H.parse("(function (f) {return f(f)})(_x)"),F=H.parse("module(_name, _f)");H.replicator=function(az){if(az&&az.core_only){return ao.replace({_x:this.parse(this.initializer)})}for(var aA=0,ay=this.modules,aB=[],ax=ay.length;aA<ax;++aA){aB.push(F.replace({_name:"'"+ay[aA]+"'",_f:this.parse(this.module(ay[aA]))}))}for(var aA=0,ax=aB.length,aw=new this.syntax(".",ao.replace({_x:this.parse(this.initializer)}));aA<ax;++aA){aw.push(aB[aA])}return aw.unflatten()};return caterwaul=H});
caterwaul.module("std.macro",function(c){var b=function(g){var d=function(h){if(h.constructor===Array){for(var k=0,j=h.length,m=[];k<j;++k){m.push(d(h[k]))}return function(l){for(var o=m.length-1,q;o>=0;--o){if(q=m[o].call(this,l)){return q}}}}else{return h.constructor===String?d(c.parse(h)):h.constructor===c.syntax?g.call(this,h):h}};return d};c.pattern=b(function(d){return function(g){return d.match(g)}});c.expander=b(function(d){return function(g){return d.replace(g)}});c.alternatives=b(function(d){throw new Error("must use replacer functions with caterwaul.alternatives()")});c.reexpander=function(g){var d=c.expander(g);return function(h){var i=d.call(this,h);return i&&this(i)}};var a=function(d){return function(h,j){var i=c.pattern(h),g=d(j);return function(k){var l=i.call(this,k);return l&&g.call(this,l)}}};c.replacer=a(c.expander);c.rereplacer=a(c.reexpander);c.macroexpand=function(d){return c(c.alternatives(Array.prototype.slice.call(arguments,1)))(d)}});caterwaul.module("std.anon",function(a){a.anonymizer=function(){for(var d={},c=0,b=arguments.length;c<b;++c){d[arguments[c]]=a.gensym(arguments[c])}return function(g){return a.parse(g).replace(d)}}});caterwaul.module("std.js",function(a){a.js=function(c){var h=function(Q){var Y=Q.data,N=Y.charAt(0),S=a.syntax;if(N!=="'"&&N!=='"'||!/#\{[^\}]+\}/.test(Y)){return false}for(var R=[],Z=[],U=1,T=Y.length-1,X=0,V=false,O=1,W;U<T;++U){if(X){if((W=Y.charAt(U))==="}"){--X||(R.push(Y.substring(O,U)),Z.push(true))&&(O=U+1),V=false}else{X+=W==="{"}}else{if((W=Y.charAt(U))==="#"){V=true}else{if(W==="{"&&V){R.push(Y.substring(O,U-1)),Z.push(false),O=U+1,++X}else{V=false}}}}R.push(Y.substring(O,T)),Z.push(false);for(var P=new RegExp("\\\\"+N,"g"),U=0,T=R.length;U<T;++U){R[U]=Z[U]?this(a.parse(R[U].replace(P,N)).as("(")):new S(N+R[U]+N)}return new S("+",R).unflatten().as("(")};var J=a.parse("var _x = _y"),M=a.parse("_x = _y"),G=a.parse("result"),L=a.parse("function (_formals) {_befores; var result = _result; _afters; return result}"),H=a.parse("function (_formals) {_befores; return _result}"),i=a.parse("_f = _x"),I=function(N){return N.is_empty()&&N.data==="result"},w=a.rereplacer("_f(_xs) = _y",function(W){for(var X=[],ab=[],ac=[],N=W._xs.flatten(","),V=0,T=N.length;V<T;++V){(ac.length||N[V].contains(I)?ac:ab.length||N[V].length?ab:X).push(N[V])}for(var S=[ab,ac],V=0,T=S.length;V<T;++V){for(var R=S[V],U=0,Z=R.length,Q;U<Z;++U){R[U]=(Q=M.match(R[U]))&&Q._x.is_empty()?J.replace(Q):R[U].as("(")}}var Y=X.length?new a.syntax(",",X).unflatten():a.empty,P=ab.length?new a.syntax(";",ab).unflatten():a.empty,O=ac.length?new a.syntax(";",ac).unflatten():a.empty,aa=i.replace({_f:W._f,_x:ac.length?L:H});return aa.replace({_formals:Y,_befores:P,_afters:O,_result:W._y})});var y=function(O){var Q=O.data,P,N;if((Q==="/"||Q==="|")&&(P=O[0]).data===Q&&P[1]&&P[1].data==="u-"&&(N=P[1][0])){return new a.syntax("()",N,this(O[0][0]).flatten(Q).push(this(O[1])).with_data(",").unflatten())}};var F=function(Q){var S=Q.data,R,P;if((S==="/"||S==="|")&&(R=Q[0]).data===S&&R[1]&&R[1].data==="u~"&&(P=R[1][0])){var O=[].slice.call(this(Q[0][0]).flatten(S)),N=O.shift();return new a.syntax("()",new a.syntax(".",new a.syntax("(",N),P),new a.syntax(",",O,this(Q[1])).unflatten())}};var o=a.parse("_f(_x)"),j=a.rereplacer("_x /!_f",function(N){return o.replace({_f:N._f,_x:this(N._x).flatten("/").with_data(",").unflatten()})});var l=a.pattern("_literal._modifier"),E=function(O,P,N){var Q=O.literal_modifiers[P];return Q.hasOwnProperty(N)&&Q[N]},u=function(P){var O=l.call(this,P),N,Q;if(O&&(N=O._literal)&&(Q=N.is_identifier()?E(this,"identifier",O._modifier.data):N.is_array()?E(this,"array",O._modifier.data):N.is_regexp()?E(this,"regexp",O._modifier.data):N.is_number()?E(this,"number",O._modifier.data):N.is_string()?E(this,"string",O._modifier.data):null)){return Q.call(this,N)}};var A=a.pattern("_modifier[_expression]"),k=a.pattern("_expression /_modifier"),C=a.pattern("_expression -_modifier"),K=a.pattern("_modifier in _expression"),z=a.pattern("_expression |_modifier"),B=a.pattern("_expression, _modifier"),v=a.pattern("_modifier._parameters"),m=a.pattern("_modifier[_parameters]"),D=a.pattern("_expression <_modifier> _parameters"),g=a.pattern("_expression -_modifier- _parameters"),b=function(S){var N,O=D.call(this,S)||g.call(this,S);if(O&&this.parameterized_modifiers.hasOwnProperty(N=O._modifier.data)){var R=this.parameterized_modifiers[N].call(this,O);if(R){return R}}var Q=A.call(this,S)||k.call(this,S)||C.call(this,S)||K.call(this,S)||z.call(this,S)||B.call(this,S);if(Q){var P=v.call(this,Q._modifier)||m.call(this,Q._modifier);if(P){Q._modifier=P._modifier;Q._parameters=P._parameters;return this.parameterized_modifiers.hasOwnProperty(N=Q._modifier.data)&&this.parameterized_modifiers[N].call(this,Q)}else{return this.modifiers.hasOwnProperty(N=Q._modifier.data)&&this.modifiers[N].call(this,Q)}}};var d=function(N){return h.call(this,N)||u.call(this,N)||N.length&&(b.call(this,N)||w.call(this,N)||y.call(this,N)||F.call(this,N)||j.call(this,N))},q=c?a(function(N){return c.call(this,N)||d.call(this,N)}):a(d);q.modifiers={};q.parameterized_modifiers={};q.literal_modifiers={regexp:{},array:{},string:{},number:{},identifier:{}};return q}});caterwaul.module("std.js-literals",function(a){a.js_literals=function(c){var b=a.parse("function (_) {return _body}");(function(d){d.x=a.reexpander(function(h){return h.with_data(h.data.replace(/\s+/g,""))});var g=a.parse("_regexp.exec(_)");d.qf=function(h){return b.replace({_body:g.replace({_regexp:h})})}})(c.literal_modifiers.regexp);(function(d){d.qw=a.reexpander(function(o){for(var q=new a.syntax("["),g=new a.syntax(","),j=o.data.charAt(0),m=o.as_escaped_string().split(/\s+/),k=0,h=m.length;k<h;++k){g.push(new a.syntax(j+m[k]+j))}return q.push(g.unflatten())});d.qh=a.reexpander(function(o){for(var q=new a.syntax("{"),g=new a.syntax(","),j=o.data.charAt(0),m=o.as_escaped_string().split(/\s+/),k=0,h=m.length;k<h;k+=2){g.push(new a.syntax(":",new a.syntax(j+m[k]+j),new a.syntax(j+m[k+1]+j)))}return q.push(g.unflatten())});d.qr=a.reexpander(function(g){return g.with_data("/"+g.as_escaped_string().replace(/\//g,"\\/")+"/")});d.qs=function(g){return new a.ref(a.parse(g.as_unescaped_string()))};d.qf=a.reexpander(function(g){return b.replace({_body:a.parse(g.as_unescaped_string())})})})(c.literal_modifiers.string);return c}});caterwaul.module("std.words",function($){var scope_template=$.parse("(function () {var _variables; return (_expression)}).call(this)"),trivial_node_template=$.parse("new caterwaul.syntax(_data)"),nontrivial_node_template=$.parse("new caterwaul.syntax(_data, _xs)");$.words=function(caterwaul_function){$.merge(caterwaul_function.modifiers,$.words.modifiers);$.merge(caterwaul_function.parameterized_modifiers,$.words.parameterized_modifiers);return caterwaul_function};$.syntax_to_expression=function(tree){if(tree.length){for(var comma=new $.syntax(","),i=0,l=tree.length;i<l;++i){comma.push($.syntax_to_expression(tree[i]))}return nontrivial_node_template.replace({_data:'"'+tree.data.replace(/"/g,'\\"').replace(/\n/g,"\\n")+'"',_xs:comma.unflatten()})}else{return trivial_node_template.replace({_data:'"'+tree.data.replace(/"/g,'\\"').replace(/\n/g,"\\n")+'"'})}};$.words.modifiers={qs:function(match){return new $.expression_ref($.syntax_to_expression(match._expression),"qs")},qse:function(match){return new $.expression_ref($.syntax_to_expression(this(match._expression)),"qse")},reexpand:function(match){return this(this(match._expression))},noexpand:function(match){return match._expression},raise:$.reexpander("(function () {throw _expression}).call(this)"),eval:function(match){return new $.ref($.compile(this(match._expression)),"eval")},delay:$.reexpander("(function (t, f) {return (function () {return f.call(t)})})(this, (function () {return _expression}))"),lazy:$.reexpander("(function (t, f, v, vc) {return (function () {return vc ? v : (vc = true, v = f.call(t))})})(this, (function () {return _expression}))"),capture:function(match){for(var comma=new $.syntax(","),bindings=match._expression.flatten(","),i=0,l=bindings.length;i<l;++i){comma.push(this(bindings[i]).with_data(":"))}return new $.syntax("{",comma.unflatten())},wcapture:function(match){for(var e=this(match._expression),comma=new $.syntax(","),bindings=e.flatten(","),node,i=0,l=bindings.length;i<l;++i){(node=this(bindings[i]))[1]=node[0],comma.push(node.with_data(":"))}return scope_template.replace({_variables:e,_expression:new $.syntax("{",comma.unflatten())})}};$.words.parameterized_modifiers={given:$.reexpander("(function (_parameters) {return _expression})"),bgiven:$.reexpander("(function (t, f) {return (function () {return f.apply(t, arguments)})})(this, (function (_parameters) {return _expression}))"),rescue:$.reexpander("(function () {try {return (_expression)} catch (e) {return (_parameters)}}).call(this)"),se:$.reexpander("(function (it) {return (_parameters), it}).call(this, (_expression))"),re:$.reexpander("(function (it) {return (_parameters)}).call(this, (_expression))"),where:$.reexpander("(function () {var _parameters; return (_expression)}).call(this)"),using:$.reexpander(function(match){var m=this(match._parameters),o=$.compile(m),comma=new $.syntax(","),expression_ref=new $.expression_ref(m);for(var k in o){if(Object.prototype.hasOwnProperty.call(o,k)){comma.push(new $.syntax("=",k,new $.syntax(".",expression_ref,k)))}}return scope_template.replace({_variables:comma.unflatten(),_expression:match._expression})}),when:$.reexpander("((_parameters) && (_expression))"),and:$.reexpander("((_expression) && (_parameters))"),unless:$.reexpander("(! (_parameters) && (_expression))"),or:$.reexpander("((_expression) || (_parameters))")}});caterwaul.module("std.seq","js words",function(a){a.seq(caterwaul_function)=caterwaul_function-se[it.modifiers.seq(match)=seq_expand.call(seq_expand,anon_pattern.replace({_x:match._expression}))-re-this(it)/when.it]-where[anon_pattern=anon("S[_x]"),seq_expand=a(a.alternatives(operator_macros.concat(word_macros)))],where[anon=a.anonymizer("S"),rule(p,e)=a.rereplacer(p.constructor===String?anon(p):p,e.constructor===String?anon(e):e),operator_macros=[rule("S[_x]","_x"),rule("S[_xs + _ys]",concat),rule("S[_xs ^ _ys]",zip),rule("S[_xs - _ys]",cross),rule("S[(_x)]","(S[_x])"),rule("S[_x[_y]]","S[_x][_y]"),rule("S[_xs(_ys)]","S[_xs](_ys)"),rule("S[[_x]]","[_x]"),rule("S[_x, _y]","S[_x], S[_y]"),rule("S[_xs._p]","S[_xs]._p"),rule("S[~[_x]]","[S[_x]]"),rule("S[~_xs(_ys)]","S[_xs](S[_ys])"),rule("S[_x ? _y : _z]","(S[_x]) ? (S[_y]) : (S[_z])"),rule("S[_x && _y]","(S[_x]) && (S[_y])"),rule("S[_x || _y]","(S[_x]) || (S[_y])"),rule("S[+_xs]","Array.prototype.slice.call((_xs))"),rule("S[_xs %_thing]",handle_filter_forms),rule("S[_xs *_thing]",handle_map_forms),rule("S[_xs /_thing]",handle_fold_forms),rule("S[_xs |_thing]",handle_exists_forms),rule("S[_xs %k*_thing]",handle_kmap_forms),rule("S[_xs %v*_thing]",handle_vmap_forms),rule("S[_xs %k%_thing]",handle_kfilter_forms),rule("S[_xs %v%_thing]",handle_vfilter_forms)]-where[unrecognized(reason)=raise[new Error(reason)],use_form(form,xs,body,init,vars)=form?form.replace({_f:body,_init:init}).replace(a.merge({_s:xs},vars)):unrecognized("unsupported sequence operator or modifiers used on #{body}"),operator_case(forms)(match)=parse_modifiers(match._thing,use(forms.normal,forms.inormal),use(forms.bang,forms.ibang),use(forms.tbang,forms.itbang))-where[xs=match._xs,expander=this,form_function(form)(body,vars)=use_form(form,xs,body,null,vars),iform_function(form)(body,init,vars)=use_form(form,xs,body,init,vars),use(form,iform)(body)=parse_body(body,expander,form_function(form),iform_function(iform))],handle_map_forms=operator_case({normal:map,bang:each,tbang:flatmap,itbang:iterate}),handle_filter_forms=operator_case({normal:filter,bang:filter_not,tbang:map_filter,itbang:imap_filter}),handle_fold_forms=operator_case({normal:foldl,bang:foldr,tbang:unfold,inormal:ifoldl,ibang:ifoldr,itbang:iunfold}),handle_kmap_forms=operator_case({normal:kmap,bang:keach}),handle_kfilter_forms=operator_case({normal:kfilter,bang:kfilter_not,tbang:kmap_filter}),handle_vmap_forms=operator_case({normal:vmap,bang:veach}),handle_vfilter_forms=operator_case({normal:vfilter,bang:vfilter_not,tbang:vmap_filter}),handle_exists_forms=operator_case({normal:exists,bang:not_exists}),block=anon("[_x]"),block_with_variable=anon("_var[_x]"),block_with_init=anon("[_init][_x]"),block_with_variable_and_init=anon("_var[_init][_x]"),block_with_closure=anon("+_x"),block_with_seq=anon("~_x"),standard_names={_x:"x",_x0:"x0",_xi:"xi",_xl:"xl",_xs:"xs",_xr:"xr"},prefixed_names(p)={_x:p,_x0:"#{p}0",_xi:"#{p}i",_xl:"#{p}l",_xs:"#{p}s",_xr:"#{p}r"},function_promotion=anon("(_f).call({_x0: _x0, _xi: _xi, _xl: _xl, _xs: _xs, _xr: _xr}, _x)"),promote_function(f)=function_promotion.replace({_f:f}),closure_wrapper=anon("(function (_x, _x0, _xi, _xl, _xs, _xr) {return _f}).call(this, _x, _x0, _xi, _xl, _xs, _xr)"),close_body(vars,f)=closure_wrapper.replace(vars).replace({_f:f}),seq_pattern=anon("S[_x]"),promote_seq(f)=seq_pattern.replace({_x:f}),parse_body(tree,expand,normal,init)=((r=block_with_seq.match(tree))?parse_body(r._x,expand,sequence_context_normal,sequence_context_init):(r=block_with_closure.match(tree))?parse_body(r._x,expand,wrapping_normal,wrapping_init):(r=block_with_variable_and_init.match(tree))?init(r._x,r._init,prefixed_names(r._var)):(r=block_with_init.match(tree))?init(r._x,r._init,standard_names):(r=block_with_variable.match(tree))?normal(r._x,prefixed_names(r._var)):(r=block.match(tree))?normal(r._x,standard_names):normal(promote_function(tree),standard_names))-where[in_sequence_context(f)=expand.call(expand,promote_seq(f)),sequence_context_normal(f,names)=normal(in_sequence_context(f),names),sequence_context_init(f,init_expression,names)=init(in_sequence_context(f),init_expression,names),wrapping_normal(f,names)=normal(close_body(names,f),names),wrapping_init(f,init_expression,names)=init(close_body(names,f),init_expression,names),r=null],tbang_modifier=anon("~!_x"),bang_modifier=anon("!_x"),parse_modifiers(tree,normal,bang,tbang)=((result=tbang_modifier.match(tree))?tbang(result._x):(result=bang_modifier.match(tree))?bang(result._x):normal(tree))-where[result=null]]-where[loop_anon=a.anonymizer("x","y","i","j","l","lj","r","o","k"),scope=anon("(function (_xs) {var _x, _x0, _xi, _xl, _xr; _body}).call(this, S[_s])"),scoped(t)=scope.replace({_body:t}),expand(s)=s.replace(/@/g,"Array.prototype.slice.call").replace(/#/g,"Object.prototype.hasOwnProperty.call").replace(/%%/g,".constructor"),form(x)=x/!expand/!anon/!scoped/!loop_anon,map=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length; _xi < _xl; ++_xi) _x = _xs[_xi], _xr.push((_f));               return _xr"),each=form("for (var                    _xi = 0, _xl = _xs.length; _xi < _xl; ++_xi) _x = _xs[_xi], (_f);                         return _xs"),flatmap=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length; _xi < _xl; ++_xi) _x = _xs[_xi], _xr.push.apply(_xr, @((_f))); return _xr"),iterate=form("for (var _x = _xs, _xi = 0, _x0, _xl;              _x0 = (_init); ++_xi) _x = (_f);                                   return _x"),filter=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length, _x0;     _xi < _xl; ++_xi) _x = _xs[_xi], (_f) && _xr.push(_x);        return _xr"),filter_not=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length, _x0;     _xi < _xl; ++_xi) _x = _xs[_xi], (_f) || _xr.push(_x);        return _xr"),map_filter=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length, _x0, _y; _xi < _xl; ++_xi) _x = _xs[_xi], (_y = (_f)) && _xr.push(_y); return _xr"),imap_filter=form("for (var _xr = new _xs%%(), _xi = 0, _xl = _xs.length, _x0; _xi < _xl; ++_xi) _x = _xs[_xi], (_x0 = (_init)) && _xr.push(_f); return _xr"),foldl=form("for (var _x0 = _xs[0], _xi = 1, _xl = _xs.length;            _xi < _xl; ++_xi) _x = _xs[_xi], _x0 = (_f); return _x0"),foldr=form("for (var _xl = _xs.length, _xi = _xl - 2, _x0 = _xs[_xl - 1]; _xi >= 0; --_xi) _x = _xs[_xi], _x0 = (_f); return _x0"),unfold=form("for (var _xr = [], _x = _xs, _xi = 0;                      _x !== null; ++_xi) _xr.push(_x), _x = (_f);   return _xr"),ifoldl=form("for (var _x0 = (_init), _xi = 0, _xl = _xs.length;      _xi < _xl; ++_xi) _x = _xs[_xi], _x0 = (_f);     return _x0"),ifoldr=form("for (var _xl = _xs.length - 1, _xi = _xl, _x0 = (_init); _xi >= 0; --_xi) _x = _xs[_xi], _x0 = (_f);     return _x0"),iunfold=form("for (var _xr = [], _x = _xs, _xi = 0, _x0;          _x0 = (_init); ++_xi) _xr.push(_x), _x = (_f);       return _xr"),exists=form("for (var _x = _xs[0], _xi = 0, _xl = _xs.length, x; _xi < _xl; ++_xi) {_x = _xs[_xi]; if (x = (_f)) return x} return false"),not_exists=form("for (var _x = _xs[0], _xi = 0, _xl = _xs.length, x; _xi < _xl; ++_xi) {_x = _xs[_xi]; if (x = (_f)) return false} return true"),concat=anon("(S[_xs]).concat((S[_ys]))"),zip=form("for (var _xr = (S[_ys]), pairs = [], i = 0, l = _xs.length; i < l; ++i) pairs.push([_xs[i], _xr[i]]); return pairs"),cross=form("for (var _xr = (S[_ys]), pairs = [], i = 0, l = _xs.length, lj = _xr.length; i < l; ++i) for (var j = 0; j < lj; ++j) pairs.push([_xs[i], _xr[j]]);return pairs"),kmap=form("var _xr = new _xs%%();  for (var _x in _xs) if (#(_xs, _x)) _xr[_f] = _xs[_x]; return _xr"),keach=form("                        for (var _x in _xs) if (#(_xs, _x)) _f;                return _xs"),kfilter=form("var _xr = new _xs%%();    for (var _x in _xs) if (#(_xs, _x) &&      (_f))  _xr[_x] = _xs[_x]; return _xr"),kfilter_not=form("var _xr = new _xs%%();    for (var _x in _xs) if (#(_xs, _x) &&    ! (_f))  _xr[_x] = _xs[_x]; return _xr"),kmap_filter=form("var _xr = new _xs%%(), x; for (var _x in _xs) if (#(_xs, _x) && (x = (_f))) _xr[x]  = _xs[_x]; return _xr"),vmap=form("var _xr = new _xs%%();    for (var  k in _xs) if (#(_xs, k)) _x = _xs[k], _xr[k] = (_f); return _xr"),veach=form("                          for (var  k in _xs) if (#(_xs, k)) _x = _xs[k], _f;            return _xs"),vfilter=form("var _xr = new _xs%%();    for (var  k in _xs) if (#(_xs, k)) _x = _xs[k],        (_f) && (_xr[k] = _x); return _xr"),vfilter_not=form("var _xr = new _xs%%();    for (var  k in _xs) if (#(_xs, k)) _x = _xs[k],        (_f) || (_xr[k] = _x); return _xr"),vmap_filter=form("var _xr = new _xs%%(), x; for (var  k in _xs) if (#(_xs, k)) _x = _xs[k], x = (_f), x && (_xr[k] =  x); return _xr")],word_macros=[rule("S[n[_upper]]",n),rule("S[ni[_upper]]",ni),rule("S[_o /keys]",keys),rule("S[_o |object]",object),rule("S[n[_lower, _upper]]",n),rule("S[ni[_lower, _upper]]",ni),rule("S[_o /values]",values),rule("S[_o -object]",object),rule("S[n[_lower, _upper, _step]]",n),rule("S[ni[_lower, _upper, _step]]",ni),rule("S[_o /pairs]",pairs),rule("S[_o /object]",object)]-where[n(match)=n_pattern.replace(a.merge({_lower:"0",_step:"1"},match)),ni(match)=ni_pattern.replace(a.merge({_lower:"0",_step:"1"},match)),n_pattern=anon("(function (i, u, s) {if ((u - i) * s <= 0) return [];for (var r = [], d = u - i; d > 0 ? i <  u : i >  u; i += s) r.push(i); return r})((_lower), (_upper), (_step))"),ni_pattern=anon("(function (i, u, s) {if ((u - i) * s <= 0) return [];for (var r = [], d = u - i; d > 0 ? i <= u : i >= u; i += s) r.push(i); return r})((_lower), (_upper), (_step))"),scope=anon("(function (o) {_body}).call(this, (S[_o]))"),scoped(t)=scope.replace({_body:t}),form(p)=tree.replace(match)-given.match-where[tree=scoped(anon(p))],keys=form("var ks = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && ks.push(k); return ks"),values=form("var vs = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && vs.push(o[k]); return vs"),pairs=form("var ps = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && ps.push([k, o[k]]); return ps"),object=form("for (var r = {}, i = 0, l = o.length, x; i < l; ++i) x = o[i], r[x[0]] = x[1]; return r")]]});caterwaul.module("std",function(a){a.js_all=function(){return this("js js_literals words seq")}});
caterwaul.module("ui.jquery","js words",function(a){a.jquery(caterwaul_function)=caterwaul_function-se[it.modifiers.jquery(match)=jquery_expand.call(jquery_expand,anon_pattern.replace({_x:match._expression}))-re-this(it)/when.it]-where[anon_pattern=anon("J[_x]"),jquery_expand=a(a.alternatives(jquery_macros.concat(string_macros).concat(search_macros)))],where[jq="jQuery",anon=a.anonymizer("J","TS","S","P","PS"),hyphenate(s)=s.replace(/_/g,"-"),rule(p,e)=a.rereplacer(anon(p),e.constructor===Function?e.call(this,match)-given.match:anon(e)),p=where[p_pattern=anon("P[_thing]")] in p_pattern.replace({_thing:node})-given.node,jquery_macros=[rule("J[_element]",given.match[match._element.is_constant()||match._element.length?wrap_in_jquery(match):become_dom_node(match)]),rule("J[_element._class]","J[_element].addClass(S[_class])"),rule("J[_element *_attr(_val)]","J[_element].attr(S[_attr], _val)"),rule("J[_element *!_name(_val)]","J[_element].data(S[_name], _val)"),rule("J[_element /_method(_args)]","J[_element]._method(_args)"),rule("J[_element /!_event(_args)]","J[_element].bind(S[_event], _args)"),rule("J[_element %_function]","_function(J[_element])"),rule("J[_element(_children)]","J[_element].append(J[_children])"),rule("J[_element[_children]]","J[_element].append(_children)"),rule("J[_element < _tree]","J[_element].append((_tree).toString())"),rule("J[_element > _child]","J[_element].append(J[_child])"),rule("J[_element >= _child]","J[_element].append(_child)"),rule("J[_element1, _element2]","J[_element1].add(J[_element2])"),rule("J[_element1 + _element2]","J[_element1].add(J[_element2])"),rule("J[_element >> _pattern]","J[_element].filter(PS[_pattern])"),rule("J[_element >>> _pattern]","J[_element].find(PS[_pattern])"),rule("J[_element << _pattern]","J[_element].parents(PS[_pattern])"),rule("J[(_element)]","(J[_element])"),rule("J[[_element]]","[J[_element]]"),rule("J[+_expression]","_expression")]-where[dom_node_template=anon("#{jq}(TS[_element])"),jquery_template=anon('#{jq}("<span>" + (_element) + "</span>")'),become_dom_node(match)=dom_node_template.replace(match),wrap_in_jquery(match)=jquery_template.replace(match)],string_macros=[rule("TS[_identifier]",string("<#{hyphenate(match._identifier.data)}>")-given.match),rule("S[_identifier]",string(hyphenate(match._identifier.data))-given.match),rule("PS[_identifier]",string(expand(p(match._identifier)).data)-given.match)]-where[string(s)=new a.syntax('"'+s.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"')],search_macros=[rule("P[_element]",new a.syntax(hyphenate(match._element.data-re[it==="_"?"*":it]))-given.match),rule("P[_element._class]",new a.syntax("#{this(p(match._element)).data}.#{hyphenate(match._class.data)}")-given.match),rule("P[_element[_attributes]]",new a.syntax("#{this(p(match._element)).data}[#{this(p(match._attributes))}]")-given.match),rule("P[_attribute = _value]",new a.syntax('#{this(p(match._attribute)).data}="#{'+interpolated(match._value)+'}"')-given.match),rule("P[(_element)]","P[_element]"),rule("P[_element1 +   _element2]",binary(", ")),rule("P[_element1,    _element2]",binary(", ")),rule("P[_element1 >>  _element2]",binary(" ")),rule("P[_element1 >>> _element2]",binary(" ")),rule("P[_element1 >   _element2]",binary(" > ")),rule("P[_element1(_element2)]",binary(" > ")),rule("P[_element /_selector]",new a.syntax("#{expand(p(match._element)).data}:#{hyphenate(match._selector.data)}")-given.match),rule("P[_element /_selector(_value)]",new a.syntax('#{expand(p(match._element)).data}:#{hyphenate(match._selector.data)}("#{'+interpolated(match._value)+'}")')-given.match)]-where[interpolated(node)='(#{node.toString()}).replace(/(\\)/g, "$1$1").replace(/(")/g, "\\$1")',binary(op)(match)=new a.syntax("#{expand(p(match._element1)).data}#{op}#{expand(p(match._element2)).data}")]]});

caterwaul('js_all')(function ($) {
  options.input_files *!waul -seq
  -where [fs                         = require('fs'),
          options                    = {extensions: [], input_files: [], output_pattern: '$1$2.js', use_std: true}
                                       -se [it.input_files = [process.argv[2]], unless [it.compile]]
                                       -se- process.argv.slice(2) *![x === '--extension' ? it.extensions /~push/ xs[++xi] :
                                                                     x === '--output'    ? it.output_pattern = xs[++xi]   :
                                                                     x === '--no-std'    ? it.use_std = false             : it.input_files /~push/ x] /seq,

          build_caterwaul            = $()('(function () {' + $ /~replicator/ {core_only: !options.use_std} +
                                                          options.extensions *[fs.readFileSync(x, 'utf8')] /seq /re [it.join(';\n') + ';\nreturn caterwaul.deglobalize()})']),

          immediate_pattern          = 'caterwaul(_transform)(_function)();'.qs,

          module_pattern             = 'caterwaul.module(_name, _transform, _function);'.qs,
          module_pattern_explicit    = 'caterwaul.module(_name, caterwaul(_transform)(_function));'.qs,
          module_template            = 'caterwaul.module(_name, _compiled);'.qs,

          waul(input_file)           = input_file /-waul_process/ $.parse(fs.readFileSync(input_file, 'utf8')),
          waul_process(file, tree)   = immediate_pattern /~match/ tree                                            -re [it ? waul_run(it)             :
                                       module_pattern    /~match/ tree -or- module_pattern_explicit /~match/ tree -re [it ? waul_transform(file, it) :
                                         raise [new Error('waul: unrecognized toplevel construct in #{file}')]]],

          waul_transform(file, m)    = fs.writeFileSync(
                                         file.replace(/^(.*\/)?([^\/]+)(\.waul)?/, options.output_pattern),
                                         module_template.replace({_name: m._name, _compiled: caterwaul(m._transform.as_escaped_string())(m._function) /!caterwaul.late_bound_tree}).toString(),
                                         'utf8')
                               -where [caterwaul = build_caterwaul()],

          waul_run(m)                = caterwaul(m._transform.as_escaped_string())(m._function) /-caterwaul.compile/ {require: require, caterwaul: caterwaul}
                               -where [caterwaul = build_caterwaul()]]}, {require: require})(caterwaul);

// Generated by SDoc 
