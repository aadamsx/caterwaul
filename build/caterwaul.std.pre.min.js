(function(d,c){var b=function(i,h){var g=function(j,o){if(j.constructor===Array){for(var q=0,k=j.length,r=[];q<k;++q){r.push(g(j[q]))}return function(l,s){for(var u=r.length-1,v;u>=0;--u){if(v=r[u].call(this,l)){return v}}}}else{return j.constructor===String?g(d.parse(j)):j.constructor===d.syntax?i.call(this,j):j}};return g};d.pattern=b(function(h,g){return function(j,i){return h.match(j)}});d.expander=b(function(h,g){return function(i,j){return h.replace(i)}});d.alternatives=b(function(g,h){throw new Error("must use replacer functions with caterwaul.alternatives()")});d.reexpander=function(i,g){var h=d.expander(i);return function(k,j){var l=h.call(this,k);return l&&this(l)}};var a=function(g,h){return function(j,o,l){var k=d.pattern(j),i=g(o);return function(q,s){var r=k.call(this,q);return r&&i.call(this,r)}}};d.replacer=a(d.expander);d.rereplacer=a(d.reexpander);d.macroexpand=function(g,h){return d(d.alternatives(Array.prototype.slice.call(arguments,1)))(g)}})(caterwaul);(function(b,a){b.anonymizer=function(g){for(var h={},d=0,c=arguments.length;d<c;++d){h[arguments[d]]=b.gensym(arguments[d])}return function(j,i){return b.parse(j).replace(h)}}})(caterwaul);(function(b,a){b.js=function(d,z){var i=function(F,C){var N=F.data,B=N.charAt(0),H=b.syntax;if(B!=="'"&&B!=='"'||!/#\{[^\}]+\}/.test(N)){return false}for(var G=[],J=1,I=N.length-1,M=0,K=false,D=1,L;J<I;++J){if(M){if((L=N.charAt(J))==="}"){--M||G.push(N.substring(D,J))&&(D=J+1),K=false}else{M+=L==="{"}}else{if((L=N.charAt(J))==="#"){K=true}else{if(L==="{"&&K){G.push(N.substring(D,J-1)),D=J+1,++M}else{K=false}}}}G.push(N.substring(D,I));for(var E=new RegExp("\\\\"+B,"g"),J=0,I=G.length;J<I;++J){G[J]=J&1?this(b.parse(G[J].replace(E,B)).as("(")):new H(B+G[J]+B)}return new H("+",G).unflatten().as("(")};var y=b.rereplacer("_left(_args) = _right","_left = (function (_args) {return _right})"),g=b.rereplacer("_left(_var = arguments) = _right","_left = (function () {var _var = arguments; return _right})"),q=function(C,B){return g.call(this,C)||y.call(this,C)};var s=b.pattern("_modifier[_expression]"),j=b.pattern("_expression /_modifier"),v=b.pattern("_expression -_modifier"),A=b.pattern("_modifier in _expression"),r=b.pattern("_expression |_modifier"),u=b.pattern("_expression, _modifier"),o=b.pattern("_modifier._parameters"),k=b.pattern("_modifier[_parameters]"),w=b.pattern("_expression <_modifier> _parameters"),h=b.pattern("_expression -_modifier- _parameters"),c=function(G,I){var B=w.call(this,G)||h.call(this,G);if(B){for(var H=this.parameterized_modifiers,E=H.length-1,F;E>=0;--E){if(F=H[E].call(this,B)){return F}}}var D=s.call(this,G)||j.call(this,G)||v.call(this,G)||A.call(this,G)||r.call(this,G)||u.call(this,G);if(D){var C=o.call(this,D._modifier)||k.call(this,D._modifier);if(C){D._modifier=C._modifier;D._parameters=C._parameters;for(var H=this.parameterized_modifiers,E=H.length-1,F;E>=0;--E){if(F=H[E].call(this,D)){return F}}}else{for(var H=this.modifiers,E=H.length-1,F;E>=0;--E){if(F=H[E].call(this,D)){return F}}}}};var l=d?b(function(B,C){return d.call(this,B)||i.call(this,B)||B.length&&(c.call(this,B)||q.call(this,B))}):b(function(B,C){return i.call(this,B)||B.length&&(c.call(this,B)||q.call(this,B))});l.modifiers=[];l.parameterized_modifiers=[];return l}})(caterwaul);(function(b,a){b.words=function(g,d){var i=function(k,l,j){return function(o,q){return o._modifier.data===k&&l.call(this,o)}},c=function(k,l,j){g.modifiers.push(i(k,l))},h=function(k,l,j){g.parameterized_modifiers.push(i(k,l))};c("qs",function(k,j){return new b.ref(k._expression,"qs")});c("qse",function(k,j){return new b.ref(this(k._expression),"qse")});c("reexpand",function(j,k){return this(this(j._expression))});c("noexpand",function(j,k){return j._expression});c("raise",b.reexpander("(function () {throw _expression}).call(this)"));h("rescue",b.reexpander("(function () {try {return (_expression)} catch (e) {return (_parameters)}}).call(this)"));h("given",b.reexpander("(function (_parameters) {return _expression})"));h("bgiven",b.reexpander("(function (t, f) {return (function () {return f.apply(t, arguments)})})(this, (function (_parameters) {return _expression}))"));c("delay",b.reexpander("(function (t, f) {return (function () {return f.call(t)})})(this, (function () {return _expression}))"));c("lazy",b.reexpander("(function (t, f, v, vc) {return (function () {return vc ? v : (vc = true, v = f.call(t))})})(this, (function () {return _expression}))"));h("se",b.reexpander("(function (it) {return (_parameters), it}).call(this, (_expression))"));h("re",b.reexpander("(function (it) {return (_parameters)}).call(this, (_expression))"));h("where",b.reexpander("(function () {var _parameters; return (_expression)}).call(this)"));h("when",b.reexpander("((_parameters) && (_expression))"));h("unless",b.reexpander("(! (_parameters) && (_expression))"));return g}})(caterwaul);caterwaul.words(caterwaul.js())(function(b,a){b.seq(caterwaul_function)=caterwaul_function-se-it.modifiers.push(given.match in this(seq_expand(anon_pattern.replace({_x:match._expression})))-when[match._modifier.data==="seq"])-where[anon_pattern=anon("S[_x]"),seq_expand=b.expander(operator_macros.concat(word_macros))],where[anon=b.anonymizer("S"),rule(p,e)=b.replacer(anon(p),e.constructor===Function?given.match in this(e.call(this,match)):anon(e)),operator_macros=[rule("S[_x]","_x"),rule("S[_x, _y]","S[_x], S[_y]"),operator("","|",exists),rule("S[(_x)]","(S[_x])"),operator("","*",map,each,flatmap),binary_operator("+",concat),operator("","%",filter,filter_not,map_filter),binary_operator("-",cross),operator("","/",foldl,foldr,unfold),binary_operator("^",zip),operator("k","*",kmap,keach),operator("v","*",vmap,veach),operator("k","%",kfilter,kfilter_not,kmap_filter),operator("v","%",vfilter,vfilter_not,vmap_filter)]-where[operator(prefix,op,normal,bang,tbang)=[]-se-it.push(trule(op,"S[_xs #{p}*[_f]]",normal),trule(op,"S[_xs #{p}*_var[_f]]",normal))-se-it.push(trule(op,"S[_xs #{p}*![_f]]",bang),trule(op,"S[_xs #{p}*!_var[_f]]",bang))/when.bang-se-it.push(trule(op,"S[_xs #{p}*~![_f]]",tbang),trule(op,"S[_xs #{p}*~!_var[_f]]",tbang))/when.tbang-re-it.concat(context_conversions(p,op))-where[p=prefix&&"%#{prefix}"],binary_operator(op,f)=rule(t("S[_xs + _ys]"),f)-where[t(pattern)=anon(pattern).replace({"+":op})]]-where[template(op,p)=anon(p).replace({"*":op}),trule(op,p,e)=rule(template(op,p),e.constructor===Function?e:template(op,e)),context_conversions(p,op)=[trule(op,"S[_xs #{p}*~[_f]]","S[_xs #{p}*[S[_f]]]"),trule(op,"S[_xs #{p}*~_var[_f]]","S[_xs #{p}*_var[S[_f]]]"),trule(op,"S[_xs #{p}*!~[_f]]","S[_xs #{p}*![S[_f]]]"),trule(op,"S[_xs #{p}*!~_var[_f]]","S[_xs #{p}*!_var[S[_f]]]"),trule(op,"S[_xs #{p}*~!~[_f]]","S[_xs #{p}*~![S[_f]]]"),trule(op,"S[_xs #{p}*~!~_var[_f]]","S[_xs #{p}*~!_var[S[_f]]]")],loop_anon=b.anonymizer("xs","ys","x","y","i","j","l","lj","r","o","k"),loop_form(x)=loop_anon(scoped(anon(x))),scope=anon("(function (xs) {_body}).call(this, S[_xs])"),scoped(tree)=scope.replace({_body:tree}),op_form(pattern)=form.replace(variables_for(match))-given.match-where[form=loop_form(pattern)],map=op_form("for (var ys = [], _xi = 0, _xl = xs.length, _x; _xi < _xl; ++_xi) _x = xs[_xi], ys.push((_f));                                 return ys"),each=op_form("for (var          _xi = 0, _xl = xs.length, _x; _xi < _xl; ++_xi) _x = xs[_xi], (_f);                                          return xs"),flatmap=op_form("for (var ys = [], _xi = 0, _xl = xs.length, _x; _xi < _xl; ++_xi) _x = xs[_xi], ys.push.apply(ys, ys.slice.call((_f)));        return ys"),filter=op_form("for (var ys = [], _xi = 0, _xl = xs.length, _x; _xi < _xl; ++_xi) _x = xs[_xi], (_f) && ys.push(_x);                           return ys"),filter_not=op_form("for (var ys = [], _xi = 0, _xl = xs.length, _x; _xi < _xl; ++_xi) _x = xs[_xi], (_f) || ys.push(_x);                           return ys"),map_filter=op_form("for (var ys = [], _xi = 0, _xl = xs.length, _x, _y; _xi < _xl; ++_xi) _x = xs[_xi], (_y = (_f)) && ys.push(_y);                return ys"),foldl=op_form("for (var _x = xs[0], _xi = 1, _xl = xs.length, _x0;            _xi < _xl; ++_xi) _x0 = xs[_xi], _x = (_f);                     return _x"),foldr=op_form("for (var _xl = xs.length - 1, _xi = _xl - 1, _x0 = xs[_xl], _x; _xi >= 0; --_xi) _x = xs[_xi], _x0 = (_f);                     return _x0"),unfold=op_form("for (var ys = [], _x = xs, _xi = 0;                          _x !== null; ++_xi) ys.push(_x), _x = (_f);                       return ys"),exists=op_form("for (var _x = xs[0], _xi = 0, _xl = xs.length, x; _xi < _xl; ++_xi) {_x = xs[_xi]; if (y = (_f)) return y} return false"),concat=op_form("return xs.concat(S[_ys])"),zip=op_form("for (var ys = S[_ys], pairs = [], i = 0, l = xs.length; i < l; ++i) pairs.push([xs[i], ys[i]]); return pairs"),cross=op_form("for (var ys = S[_ys], pairs = [], i = 0, l = xs.length, lj = ys.length; i < l; ++i) for (var j = 0; j < lj; ++j) pairs.push([xs[i], ys[j]]);return pairs"),kmap=op_form("var r = {};        for (var _x in xs) if (Object.prototype.hasOwnProperty.call(xs, _x)) r[_f] = xs[_x];                        return r"),keach=op_form("                   for (var _x in xs) if (Object.prototype.hasOwnProperty.call(xs, _x)) _f;                                    return xs"),kfilter=op_form("var r = {};        for (var _x in xs) if (Object.prototype.hasOwnProperty.call(xs, _x) &&      (_f))  r[_x] = xs[_x];          return r"),kfilter_not=op_form("var r = {};        for (var _x in xs) if (Object.prototype.hasOwnProperty.call(xs, _x) &&    ! (_f))  r[_x] = xs[_x];          return r"),kmap_filter=op_form("var r = {}, x;     for (var _x in xs) if (Object.prototype.hasOwnProperty.call(xs, _x) && (x = (_f))) r[x]  = xs[_x];          return r"),vmap=op_form("var r = {}, _x;    for (var  k in xs) if (Object.prototype.hasOwnProperty.call(xs, k)) _x = xs[k], r[k] = (_f);                return r"),veach=op_form("var _x;            for (var  k in xs) if (Object.prototype.hasOwnProperty.call(xs, k)) _x = xs[k], _f;                         return xs"),vfilter=op_form("var r = {}, _x;    for (var  k in xs) if (Object.prototype.hasOwnProperty.call(xs, k)) _x = xs[k],        (_f) && (r[k] = _x); return r"),vfilter_not=op_form("var r = {}, _x;    for (var  k in xs) if (Object.prototype.hasOwnProperty.call(xs, k)) _x = xs[k],        (_f) || (r[k] = _x); return r"),vmap_filter=op_form("var r = {}, _x, x; for (var  k in xs) if (Object.prototype.hasOwnProperty.call(xs, k)) _x = xs[k], x = (_f), x && (r[k] =  x); return r"),variables_for(m)=b.merge({},m,prefixed_hash(m._var)),prefixed_hash(p)={_x:name,_xi:"#{name}i",_xl:"#{name}l",_x0:"#{name}0"}-where[name=p&&p.data||"x"]],word_macros=[rule("S[n[_upper]]",n),rule("S[_o /keys]",keys),rule("S[_o |object]",object),rule("S[n[_lower, _upper]]",n),rule("S[_o /values]",values),rule("S[_o -object]",object),rule("S[n[_lower, _upper, _step]]",n),rule("S[_o /pairs]",pairs),rule("S[_o /object]",object)]-where[n(match)=n_pattern.replace(b.merge({_lower:"0",_step:"1"},match)),n_pattern=anon("(function (i, u, s) {if ((u - i) * s <= 0) return [];for (var r = [], d = u - i; d > 0 ? i < u : i > u; i += s) r.push(i); return r})((_lower), (_upper), (_step))"),scope=anon("(function (o) {_body}).call(this, (S[_o]))"),scoped(t)=scope.replace({_body:t}),form(p)=tree.replace(match)-given.match-where[tree=scoped(anon(p))],keys=form("var ks = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && ks.push(k); return ks"),values=form("var vs = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && vs.push(o[k]); return vs"),pairs=form("var ps = []; for (var k in o) Object.prototype.hasOwnProperty.call(o, k) && ps.push([k, o[k]]); return ps"),object=form("for (var r = {}, i = 0, l = o.length, x; i < l; ++i) x = o[i], r[x[0]] = x[1]; return r")]]})(caterwaul);caterwaul.js_all=function(a){return this.seq(this.words(this.js()))};